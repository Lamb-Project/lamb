# Open WebUI Database Entity-Relationship Diagram

**Database:** Open WebUI Database (`webui.db`)  
**Type:** SQLite  
**Last Updated:** November 2025

---

## Overview

This diagram shows the Open WebUI database structure. LAMB integrates with Open WebUI for:

- **Authentication** (user, auth tables)
- **Chat interface** (models displayed to users)
- **Access control** (groups control who can use which models)
- **User management** (user profiles and settings)

**Note:** This is a separate database from the LAMB database. Integration happens via email-based links and group IDs.

---

## Entity-Relationship Diagram

```mermaid
erDiagram
    user ||--o{ auth : "authenticates"
    user ||--o{ group : "owns"
    user ||--o{ model : "creates"
    
    group ||--o{ model : "restricts_access"
    
    user {
        TEXT id PK "UUID"
        TEXT name
        TEXT email UK
        TEXT role "admin or user"
        TEXT profile_image_url
        TEXT api_key UK
        INTEGER created_at
        INTEGER updated_at
        INTEGER last_active_at
        TEXT settings "JSON"
        TEXT info "JSON"
        TEXT oauth_sub
    }
    
    auth {
        TEXT id PK "UUID"
        TEXT email UK
        TEXT password "bcrypt hashed"
        INTEGER active "0 or 1"
    }
    
    group {
        TEXT id PK "UUID"
        TEXT user_id FK
        TEXT name
        TEXT description
        JSON data
        JSON meta
        JSON permissions "Read/write access lists"
        JSON user_ids "Array of user IDs"
        INTEGER created_at
        INTEGER updated_at
    }
    
    model {
        TEXT id PK "lamb_assistant.{id}"
        TEXT user_id FK
        TEXT base_model_id "LAMB backend URL"
        TEXT name
        JSON params "Assistant configuration"
        JSON meta "Additional metadata"
        INTEGER created_at
        INTEGER updated_at
    }
```

---

## Key Tables

### user
**Purpose:** User accounts for Open WebUI

**Key Fields:**
- `id` - UUID primary key
- `email` - Unique email (links to LAMB Creator_users)
- `role` - Admin or regular user
- `api_key` - For API access to OWI

**Usage in LAMB:**
- When LAMB creates a Creator_users, it also creates an OWI user
- Email serves as the link between databases
- JWT tokens generated for authenticated sessions

### auth
**Purpose:** Password storage and authentication

**Key Fields:**
- `id` - UUID (matches user.id)
- `email` - Unique email
- `password` - bcrypt hashed (cost factor 12)
- `active` - Account status

**Security:**
- Passwords only stored here (LAMB never stores passwords)
- LAMB verifies passwords via OWI bridge
- Password changes update this table only

### group
**Purpose:** Access control for models (published assistants)

**Key Fields:**
- `id` - UUID primary key
- `user_id` - Group owner
- `permissions` - JSON with read/write access lists
- `user_ids` - JSON array of UUIDs with access

**Usage in LAMB:**
- Published assistants create/update OWI groups
- LAMB stores `group_id` in assistants table
- Assistant sharing updates group membership
- LTI users added to appropriate groups

**Permissions Structure:**
```json
{
  "read": {
    "group_ids": [],
    "user_ids": ["uuid-1", "uuid-2", "uuid-3"]
  },
  "write": {
    "group_ids": [],
    "user_ids": []
  }
}
```

### model
**Purpose:** Published assistants appear as models in OWI

**Key Fields:**
- `id` - Format: `lamb_assistant.{assistant_id}`
- `base_model_id` - LAMB backend URL for completions
- `params` - Assistant configuration
- `meta` - Additional metadata

**Usage in LAMB:**
- When assistant is published, LAMB creates model record
- Model ID format links to LAMB assistant
- Completions routed back to LAMB backend
- Access controlled via groups

---

## Integration with LAMB Database

### Email-Based Links

```
LAMB Database                   ←→   Open WebUI Database
────────────────────────────────────────────────────────
Creator_users.user_email        ←→   user.email
Creator_users.user_email        ←→   auth.email
```

**How it works:**
1. LAMB creates Creator_users with email
2. LAMB creates corresponding OWI user and auth records
3. Email serves as the primary link
4. Login verified against OWI auth table
5. JWT tokens generated by OWI

### Group ID Links

```
LAMB Database                   ←→   Open WebUI Database
────────────────────────────────────────────────────────
assistants.group_id             ←→   group.id
assistant_publish.group_id      ←→   group.id
```

**How it works:**
1. LAMB publishes assistant
2. LAMB creates/updates OWI group
3. Group ID stored in LAMB database
4. LAMB manages group membership
5. OWI enforces access control

### Model ID Links

```
LAMB Database                   ←→   Open WebUI Database
────────────────────────────────────────────────────────
assistants.id                   ←→   model.id (as lamb_assistant.{id})
```

**How it works:**
1. LAMB publishes assistant with id=42
2. LAMB creates OWI model with id="lamb_assistant.42"
3. OWI chat interface displays model
4. User sends message to model
5. OWI routes to LAMB backend via base_model_id
6. LAMB processes completion

---

## Data Flow: User Login

```
1. User enters email/password in LAMB frontend
2. LAMB sends credentials to /creator/login endpoint
3. LAMB verifies email exists in Creator_users table
4. LAMB checks user_type and enabled status
5. LAMB calls OWI bridge to verify password
6. OWI checks auth table (bcrypt verification)
7. OWI generates JWT token
8. LAMB returns token + user info to frontend
9. If creator: Frontend stores token, shows creator interface
10. If end_user: Frontend redirects to OWI with token
```

---

## Data Flow: Assistant Publishing

```
1. Creator publishes assistant in LAMB
2. LAMB creates assistant_publish record
3. LAMB creates/updates OWI group
   - Generates group ID
   - Sets permissions
   - Adds creator to group
4. LAMB creates OWI model
   - ID: lamb_assistant.{id}
   - base_model_id: LAMB backend URL
   - params: Assistant config
5. LAMB stores group_id in assistants table
6. Published assistant appears in OWI chat
```

---

## Data Flow: Assistant Sharing

```
1. Creator shares assistant with users
2. LAMB creates assistant_shares records
3. LAMB gets or creates OWI group
4. LAMB adds users to group.user_ids
5. LAMB updates group permissions
6. Shared users can now access assistant in OWI
```

---

## Data Flow: LTI Launch

```
1. Student clicks LTI activity in LMS
2. LMS sends LTI launch POST to LAMB
3. LAMB validates OAuth signature
4. LAMB extracts user info (email, name)
5. LAMB creates/finds OWI user
6. LAMB adds user to assistant's OWI group
7. LAMB generates JWT token
8. LAMB creates lti_users record
9. LAMB redirects to OWI chat with token
10. Student interacts with assistant
```

---

## Security Considerations

### Password Storage
- Passwords only in OWI auth table
- bcrypt hashed with cost factor 12
- LAMB never stores or sees plain-text passwords
- LAMB only verifies via OWI bridge

### Token Management
- JWT tokens generated by OWI
- Tokens include expiration
- LAMB validates tokens via OWI bridge
- Tokens passed in Authorization headers

### Access Control
- Groups enforce model access
- Permissions checked by OWI
- LAMB manages group membership
- User must be in group to access model

### Data Isolation
- Multi-tenancy at LAMB level (organizations)
- No cross-organization data leakage
- Groups isolate assistants
- Email-based linking preserves privacy

---

## Legend

- **PK** = Primary Key
- **FK** = Foreign Key
- **UK** = Unique Key
- **UUID** = Universally Unique Identifier
- **||--o{** = One-to-Many relationship

---

**Related Documentation:**
- [Complete Database Schema](../LAMB_DATABASE_SCHEMA.md)
- [LAMB Database](./LAMB_Database_ER_Diagram.md)
- [Simplified Overview](./Relationships_Overview_Diagram.md)
- [Architecture Documentation](../lamb_architecture.md)

