services:
  openwebui:
    image: python:3.11-slim
    working_dir: ${LAMB_PROJECT_PATH}/open-webui/backend
    environment:
      - PORT=8080
      - WEBUI_AUTH_TRUSTED_EMAIL_HEADER=X-User-Email
      - WEBUI_AUTH_TRUSTED_NAME_HEADER=X-User-Name
      - PIP_DISABLE_PIP_VERSION_CHECK=1
      - PIP_CACHE_DIR=/root/.cache/pip
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - DEFAULT_USER_ROLE=user
      - GLOBAL_LOG_LEVEL=WARNING
    volumes:
      - ${LAMB_PROJECT_PATH}:${LAMB_PROJECT_PATH}
      - pip-cache:/root/.cache/pip
    ports:
      - "8080:8080"
    depends_on:
      openwebui-build:
        condition: service_completed_successfully
    command: >
      sh -lc "echo 'Build folder found, starting backend server...' && \
      cd ${LAMB_PROJECT_PATH}/open-webui/backend && \
      python -m pip install --upgrade pip && \
      pip install -r requirements.txt && \
      mkdir -p data && \
      LOG_LEVEL=$$(echo \"$${GLOBAL_LOG_LEVEL:-WARNING}\" | tr '[:upper:]' '[:lower:]') && \
      uvicorn open_webui.main:app --port $$PORT --host 0.0.0.0 --forwarded-allow-ips '*' --reload --log-level $$LOG_LEVEL --no-access-log"
  openwebui-build:
    image: node:20-alpine
    working_dir: ${LAMB_PROJECT_PATH}/open-webui
    volumes:
      - ${LAMB_PROJECT_PATH}:${LAMB_PROJECT_PATH}
    environment:
      - NODE_OPTIONS=--max-old-space-size=4096
    command: >
      sh -lc "if [ ! -d ${LAMB_PROJECT_PATH}/open-webui/build ] || [ -z \"$(ls -A ${LAMB_PROJECT_PATH}/open-webui/build 2>/dev/null)\" ]; then npm install && npm run build; else echo 'Build folder already exists, skipping build.'; fi"
    # This service only runs the build step and exits
  frontend-build:
    image: node:20-alpine
    working_dir: ${LAMB_PROJECT_PATH}/frontend/svelte-app
    volumes:
      - ${LAMB_PROJECT_PATH}:${LAMB_PROJECT_PATH}
    command: >
      sh -lc "apk add --no-cache git && \
      git config --global --add safe.directory ${LAMB_PROJECT_PATH} && \
      npm install && npm run build"
    # This service only runs the build step and exits
  kb:
    image: python:3.11-slim
    working_dir: ${LAMB_PROJECT_PATH}/lamb-kb-server-stable/backend
    environment:
      - PIP_DISABLE_PIP_VERSION_CHECK=1
      - PIP_CACHE_DIR=/root/.cache/pip
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - GLOBAL_LOG_LEVEL=WARNING
      - KB_LOG_LEVEL=WARNING
    volumes:
      - ${LAMB_PROJECT_PATH}:${LAMB_PROJECT_PATH}
      - pip-cache:/root/.cache/pip
    ports:
      - "9090:9090"
    command: >
      sh -lc "python -m pip install --upgrade pip && \
      pip install -r requirements.txt && \
      mkdir -p static && \
      (test -f .env || cp .env.example .env) && \
      LOG_LEVEL=$$(echo \"$${KB_LOG_LEVEL:-$${GLOBAL_LOG_LEVEL:-WARNING}}\" | tr '[:upper:]' '[:lower:]') && \
      uvicorn main:app --host 0.0.0.0 --port 9090 --reload --log-level $$LOG_LEVEL --no-access-log"
  backend:
    image: python:3.11-slim
    working_dir: ${LAMB_PROJECT_PATH}/backend
    environment:
      - PORT=9099
      - PIP_DISABLE_PIP_VERSION_CHECK=1
      - PIP_CACHE_DIR=/root/.cache/pip
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - GLOBAL_LOG_LEVEL=WARNING
    env_file:
      - ${LAMB_PROJECT_PATH}/backend/.env
    volumes:
      - ${LAMB_PROJECT_PATH}:${LAMB_PROJECT_PATH}
      - pip-cache:/root/.cache/pip
    ports:
      - "9099:9099"
    depends_on:
      openwebui:
        condition: service_started
      kb:
        condition: service_started
      frontend-build:
        condition: service_completed_successfully
    command: >
      sh -lc "python -m pip install --upgrade pip && \
      pip install -r requirements.txt && \
      LOG_LEVEL=$$(echo \"$${GLOBAL_LOG_LEVEL:-WARNING}\" | tr '[:upper:]' '[:lower:]') && \
      uvicorn main:app --port $$PORT --host 0.0.0.0 --forwarded-allow-ips '*' --reload --log-level $$LOG_LEVEL --no-access-log"
  frontend:
    image: node:20-alpine
    working_dir: ${LAMB_PROJECT_PATH}/frontend/svelte-app
    environment:
      - HOST=0.0.0.0
      - PROXY_TARGET=http://backend:9099
    volumes:
      - ${LAMB_PROJECT_PATH}:${LAMB_PROJECT_PATH}
    ports:
      - "5173:5173"
    depends_on:
      backend:
        condition: service_started
      frontend-build:
        condition: service_completed_successfully
    command: >
      sh -lc "apk add --no-cache git && \
      git config --global --add safe.directory ${LAMB_PROJECT_PATH} && \
      test -f static/config.js || cp static/config.js.sample static/config.js; \
      mkdir -p ${LAMB_PROJECT_PATH}/frontend/build/static/img && \
      mkdir -p ${LAMB_PROJECT_PATH}/frontend/build/static/md && \
      cp ${LAMB_PROJECT_PATH}/backend/static/img/lamb_icon.png ${LAMB_PROJECT_PATH}/frontend/build/static/img/ && \
      cp ${LAMB_PROJECT_PATH}/backend/static/md/lamb-news.md ${LAMB_PROJECT_PATH}/frontend/build/static/md/ && \
      npm run dev -- --host 0.0.0.0"
networks:
  default:
    name: lamb-${COMPOSE_PROJECT_NAME:-default}
volumes:
  pip-cache:
