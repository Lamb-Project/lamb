<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lamb Assistants Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="/static/css/lamb.css">
    <style>
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            cursor: pointer;
            font-size: 24px;
        }

        .modal-form label {
            display: block;
            margin-top: 10px;
        }

        .modal-form input {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
        }

        .modal-form button {
            margin-top: 20px;
            width: 100%;
        }

        .assistants-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .assistants-table th,
        .assistants-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .assistants-table th {
            background-color: #f5f5f5;
            font-weight: bold;
        }
        
        .assistants-table tr:hover {
            background-color: #f9f9f9;
        }
        
        .unpublish-button {
            background-color: #ff4444;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .unpublish-button:hover {
            background-color: #cc0000;
        }

        .inspect-button,
        .users-button {
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
        }
        
        .inspect-button:hover {
            background-color: #45a049;
        }
        
        .users-button:hover {
            background-color: #1976D2;
        }
        
        .users-table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px;
        }
        
        .users-table th,
        .users-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .users-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .users-table th {
            background-color: #4CAF50;
            color: white;
        }

        select[multiple] {
            width: 100%;
            min-height: 120px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            margin-top: 5px;
        }

        select[multiple] option {
            padding: 8px;
            margin: 2px 0;
            border-radius: 4px;
        }

        select[multiple] option:hover {
            background-color: #f0f0f0;
        }

        select[multiple] option:checked {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        /* Add helper text below the multi-select */
        .helper-text {
            font-size: 0.8em;
            color: #666;
            margin-top: 4px;
            display: block;
        }

        .creator-select-section {
            margin-bottom: 20px;
        }
        
        .creator-select-section select {
            padding: 8px;
            min-width: 200px;
            margin-left: 10px;
        }

        .assistants-list-table {
            margin: 20px 0;
            width: 100%;
        }

        .assistants-list-table .assistants-table {
            width: 100%;
            border-collapse: collapse;
        }

        .assistants-list-table .assistants-table th,
        .assistants-list-table .assistants-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .assistants-list-table .assistants-table th {
            background-color: #f5f5f5;
            font-weight: bold;
        }

        .assistants-list-table .assistants-table tr:hover {
            background-color: #f9f9f9;
        }

        .icon-button {
            position: relative;
        }

        .icon-button:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 4px 8px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(4, 32px);  /* 4 fixed columns */
            gap: 12px;  /* Increased gap between buttons */
            justify-content: start;
        }

        /* Add these classes for consistent column placement */
        .action-inspect { grid-column: 1; }    /* First column: Inspect */
        .action-users { grid-column: 2; }      /* Second column: Users */
        .action-publish { grid-column: 3; }    /* Third column: Publish/Unpublish */
        .action-delete { grid-column: 4; }     /* Fourth column: Delete/Soft Delete */

        .icon-button {
            width: 32px;
            height: 32px;
            padding: 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            margin: 0;
            color: rgba(0, 0, 0, 0.5);  /* Slightly darker icons */
        }

        /* Pastel colors for buttons - ultra soft version */
        .icon-button[data-tooltip="Duplicate"] {
            background-color: #D6EDFF;  /* Ultra soft blue */
        }

        .icon-button[data-tooltip="Publish"] {
            background-color: #EAF7D8;  /* Ultra soft green */
        }

        .icon-button[data-tooltip="Delete"] {
            background-color: #FFEEEE;  /* Ultra soft pink/red */
        }

        .icon-button[data-tooltip="Soft Delete"] {
            background-color: #FFF2D9;  /* Ultra soft orange */
        }

        .icon-button[data-tooltip="Inspect"] {
            background-color: #EAF7D8;  /* Ultra soft green */
        }

        .icon-button[data-tooltip="Users"] {
            background-color: #D6EDFF;  /* Ultra soft blue */
        }

        .icon-button[data-tooltip="Unpublish"] {
            background-color: #FFEEEE;  /* Ultra soft pink/red */
        }

        /* Hover effect - darken slightly more for better feedback */
        .icon-button:hover {
            filter: brightness(0.9);
        }
    </style>
</head>
<body>
    {% include 'navigation.html' %}

    <!-- Secondary Navigation -->
    <div id="secondary-sidebar">
        <h2>Features</h2>
        <div class="menu-item active" onclick="showFeature('create-assistant')">Create Assistant</div>
        <div class="menu-item" onclick="showFeature('edit-assistant')">Manage all assistants</div>
        <div class="menu-item" onclick="showFeature('published-assistants')">Published Assistants</div>
        <div class="menu-item" onclick="showFeature('creator-published-assistants')">Creator Published Assistants</div>
    </div>

    <div id="main-content" class="has-secondary-sidebar">
        <h1>Lamb Assistants Manager</h1>
        
        <div id="api-key-section">
            <label for="apiKey">API Key:</label>
            <input type="text" id="apiKey" required value="{{ api_key }}">
        </div>

        <div id="create-assistant" class="feature-section active">
            <h2>Create Assistant</h2>
            <p><strong>Note:</strong> This form behaves in a diferent way than the "Creator UserÂ´s" Create Assistant. This form will only create the assistant 
                wich means that it will not create a published_asssitant record. The admin user needs to make it mahually. 
                for now. .</p>
            <form id="createAssistantForm">
                <label for="assistantName">Name:</label>
                <input type="text" id="assistantName" required value="test assistant 1">

                <label for="assistantDescription">Description:</label>
                <textarea id="assistantDescription" required rows="4" cols="50">An AI assistant designed to test this thing</textarea>

                <label for="assistantOwner">Owner:</label>
                <input type="text" id="assistantOwner" required readonly>

                <label for="assistantApiCallback">API Callback:</label>
                <input type="text" id="assistantApiCallback" value="https://api.company.com/callback">

                <label for="assistantSystemPrompt">System Prompt:</label>
                <textarea id="assistantSystemPrompt" required rows="4" cols="50">You are a wise surfer dude and a helpful teaching assistant that uses Retrieval-Augmented Generation (RAG) to improve your answers.</textarea>

                <label for="assistantPromptTemplate">Prompt Template:</label>
                <textarea id="assistantPromptTemplate" required rows="4" cols="50">You are a wise surfer dude and a helpful teaching assistant that uses Retrieval-Augmented Generation (RAG) to improve your answers.
This is the user input: {user_input}
This is the context: {context}
Now answer the question:</textarea>

                <label for="assistantPreRetrievalEndpoint">Pre-Retrieval Endpoint:</label>
                <input type="text" id="assistantPreRetrievalEndpoint" value="https://api.company.com/pre-retrieval">

                <label for="assistantPostRetrievalEndpoint">Post-Retrieval Endpoint:</label>
                <input type="text" id="assistantPostRetrievalEndpoint" value="https://api.company.com/post-retrieval">

                <label for="assistantRAGEndpoint">RAG Endpoint:</label>
                <input type="text" id="assistantRAGEndpoint" value="https://api.company.com/rag">

                <label for="assistantRAGTopK">RAG Top K:</label>
                <input type="number" id="assistantRAGTopK" value="5">

                <label for="assistantRAGCollections">RAG Collections:</label>
                <select id="assistantRAGCollections" multiple>
                    <option value="">Loading collections...</option>
                </select>
                <span class="helper-text">Hold Ctrl/Cmd to select multiple collections</span>

                <button type="submit">Create Assistant</button>
            </form>
            <pre id="createAssistantResponse"></pre>
        </div>

        <div id="edit-assistant" class="feature-section">
            <h2>Manage all assistants</h2>
            
            <!-- Replace dropdown with table -->
            <div class="assistants-list-table">
                <table class="assistants-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Owner</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="editAssistantsBody">
                        <!-- Table content will be populated dynamically -->
                    </tbody>
                </table>
            </div>
            
            <div id="editAssistantResponse"></div>

            <!-- Keep the existing edit form but hide it initially -->
            <div id="assistantDetails" style="display: none;">
                <form id="editAssistantForm">
                    <div class="name-with-duplicate">
                        <div class="name-field">
                            <label for="editAssistantName">Name:</label>
                            <input type="text" 
                                   id="editAssistantName" 
                                   required 
                                   oninput="handleNameChange()"
                                   data-original-name="">
                            <span id="nameHelperText" class="helper-text">
                                Change the name to create a duplicate assistant
                            </span>
                        </div>
                        <div class="button-group">
                            <button type="button" 
                                    id="duplicateButton" 
                                    onclick="duplicateAssistant()" 
                                    class="duplicate-button" 
                                    disabled>
                                <span class="duplicate-icon">â§</span>
                                Duplicate
                            </button>
                            <button type="button"
                                    id="publishButton"
                                    onclick="showPublishModal()"
                                    class="publish-button"
                                    style="background-color: #4CAF50; color: white;">
                                <span class="publish-icon">ð¤</span>
                                Publish
                            </button>
                            <button type="button"
                                    id="deleteButton"
                                    onclick="confirmDelete()"
                                    class="delete-button"
                                    style="background-color: #ff4444; color: white;">
                                <span class="delete-icon">ð</span>
                                Delete
                            </button>
                        </div>
                    </div>

                    <label for="editAssistantDescription">Description:</label>
                    <textarea id="editAssistantDescription" required rows="4" cols="50"></textarea>

                    <label for="editAssistantApiCallback">API Callback:</label>
                    <input type="text" id="editAssistantApiCallback">

                    <label for="editAssistantSystemPrompt">System Prompt:</label>
                    <textarea id="editAssistantSystemPrompt" required rows="4" cols="50"></textarea>

                    <label for="editAssistantPromptTemplate">Prompt Template:</label>
                    <textarea id="editAssistantPromptTemplate" required rows="4" cols="50"></textarea>

                    <label for="editAssistantPreRetrievalEndpoint">Pre-Retrieval Endpoint:</label>
                    <input type="text" id="editAssistantPreRetrievalEndpoint">

                    <label for="editAssistantPostRetrievalEndpoint">Post-Retrieval Endpoint:</label>
                    <input type="text" id="editAssistantPostRetrievalEndpoint">

                    <label for="editAssistantRAGEndpoint">RAG Endpoint:</label>
                    <input type="text" id="editAssistantRAGEndpoint">

                    <label for="editAssistantRAGTopK">RAG Top K:</label>
                    <input type="number" id="editAssistantRAGTopK">

                    <label for="editAssistantRAGCollections">RAG Collections:</label>
                    <select id="editAssistantRAGCollections" multiple>
                        <option value="">Loading collections...</option>
                    </select>
                    <span class="helper-text">Hold Ctrl/Cmd to select multiple collections</span>

                    <button type="submit" id="updateButton">Update Assistant</button>
                </form>
            </div>
        </div>

        <div id="published-assistants" class="feature-section">
            <h2>Published Assistants</h2>
            <div id="publishedAssistantsTable">
                <table class="assistants-table">
                    <thead>
                        <tr>
                            <th>Assistant Name</th>
                            <th>Group Name</th>
                            <th>OAuth Consumer</th>
                            <th>Created At</th>
                            <th>Owner</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="publishedAssistantsBody">
                        <!-- Table content will be populated dynamically -->
                    </tbody>
                </table>
            </div>
            <div id="publishedAssistantsResponse"></div>
        </div>

        <div id="creator-published-assistants" class="feature-section">
            <h2>Creator Published Assistants</h2>
            
            <div class="creator-select-section">
                <label for="creatorSelect">Select Creator:</label>
                <select id="creatorSelect" onchange="loadCreatorPublishedAssistants()">
                    <option value="">Select a creator</option>
                </select>
            </div>
            
            <div id="creatorPublishedAssistantsTable">
                <table class="assistants-table">
                    <thead>
                        <tr>
                            <th>Assistant Name</th>
                            <th>Group Name</th>
                            <th>OAuth Consumer</th>
                            <th>Created At</th>
                            <th>Owner</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="creatorPublishedAssistantsBody">
                        <!-- Table content will be populated dynamically -->
                    </tbody>
                </table>
            </div>
            <div id="creatorPublishedAssistantsResponse"></div>
            
            <!-- Simplified debug box -->
            <div id="debugBox" style="
                margin: 10px 0;
                padding: 10px;
                background-color: #f5f5f5;
                border: 1px solid #ddd;
                border-radius: 4px;
                max-height: 200px;
                overflow-y: auto;
            ">
                <h4 style="margin: 0 0 10px 0;">Debug Information</h4>
                <pre id="debugContent" style="margin: 0; white-space: pre-wrap;"></pre>
            </div>
        </div>
    </div>

    <div id="publishModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Publish Assistant</h3>
                <span class="modal-close" onclick="closePublishModal()">&times;</span>
            </div>
            <form id="publishForm" class="modal-form">
                <label for="groupName">Group Name:</label>
                <input type="text" id="groupName" required>
                
                <label for="oauthConsumer">OAuth Consumer Name:</label>
                <input type="text" id="oauthConsumer" required>
                
                <button type="submit" class="publish-button" style="background-color: #4CAF50; color: white;">
                    <span class="publish-icon">ð¤</span> Publish Assistant
                </button>
            </form>
        </div>
    </div>

    <div id="inspectModal" class="modal-overlay">
        <div class="modal-content" style="width: 600px;">
            <div class="modal-header">
                <h3>Assistant Details</h3>
                <span class="modal-close" onclick="closeInspectModal()">&times;</span>
            </div>
            <div id="inspectContent" style="max-height: 70vh; overflow-y: auto;">
                <!-- Content will be populated dynamically -->
            </div>
        </div>
    </div>

    <div id="usersModal" class="modal-overlay">
        <div class="modal-content" style="width: 500px;">
            <div class="modal-header">
                <h3>Group Users</h3>
                <span class="modal-close" onclick="closeUsersModal()">&times;</span>
            </div>
            <div id="usersContent">
                <!-- Content will be populated dynamically -->
            </div>
        </div>
    </div>

    <script>
        // Function to show/hide features
        function showFeature(featureId) {
            // Hide all feature sections
            document.querySelectorAll('.feature-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all menu items
            document.querySelectorAll('#secondary-sidebar .menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected feature section
            const selectedFeature = document.getElementById(featureId);
            if (selectedFeature) {
                selectedFeature.classList.add('active');
            }
            
            // Add active class to selected menu item
            const selectedMenuItem = document.querySelector(`#secondary-sidebar .menu-item[onclick*="${featureId}"]`);
            if (selectedMenuItem) {
                selectedMenuItem.classList.add('active');
            }

            // If switching to edit assistant, reload the list
            if (featureId === 'edit-assistant') {
                loadAssistants();
            }

            // If switching to published assistants, load the list
            if (featureId === 'published-assistants') {
                loadPublishedAssistants();
            }
        }

        // Make sure DOM is loaded before adding event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Add class to body to indicate secondary sidebar presence
            document.body.classList.add('has-secondary-sidebar');

            // Function to safely add event listener
            function addSafeEventListener(elementId, eventType, handler) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.addEventListener(eventType, handler);
                } else {
                    console.warn(`Element with id '${elementId}' not found`);
                }
            }

            // Update the publish form event listener
            addSafeEventListener('publishForm', 'submit', handlePublishFormSubmit);

            // Close modal when clicking outside
            const publishModal = document.getElementById('publishModal');
            if (publishModal) {
                publishModal.addEventListener('click', function(event) {
                    if (event.target === this) {
                        closePublishModal();
                    }
                });
            }

            // Set owner field from userDisplayName
            const userDisplayName = document.getElementById('userDisplayName');
            const assistantOwner = document.getElementById('assistantOwner');
            if (userDisplayName && assistantOwner) {
                assistantOwner.value = userDisplayName.textContent;
            }

            // Add all event listeners
            addSafeEventListener('createAssistantForm', 'submit', createAssistant);
            addSafeEventListener('editAssistantForm', 'submit', handleEditAssistantSubmit);

            // Initial load of user's assistants
            loadAssistants();

            // Load collections when the page loads
            loadChromaCollections();

            // Load creator users when the page loads
            loadCreatorUsers();
        });

        // Separate the publish form handler for better organization
        async function handlePublishFormSubmit(event) {
            event.preventDefault();
            console.log('Publish form submitted');
            
            // Show loading state
            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            console.log('Original button text:', originalText);
            submitButton.innerHTML = 'Publishing...';
            submitButton.disabled = true;
            
            const apiKey = document.getElementById('apiKey').value;
            const assistantId = document.getElementById('assistantSelect').value;
            const assistantName = document.getElementById('editAssistantName').value;
            const assistantOwner = document.getElementById('userDisplayName').textContent;
            const groupName = document.getElementById('groupName').value;
            const oauthConsumer = document.getElementById('oauthConsumer').value;

            const url = `/lamb/v1/assistant/publish_assistant/${assistantId}?group_name=${encodeURIComponent(groupName)}&oauth_consumer_name=${encodeURIComponent(oauthConsumer)}`;
            console.log('Making API request to:', url);
            try {
                const response = await axios.post(
                    url,
                    null,  // No body needed since all parameters are in the URL
                    {
                        headers: { 
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        }
                    }
                );

                console.log('API response:', response);
                closePublishModal();
                document.getElementById('editAssistantResponse').innerHTML = 
                    `<p style="color: green;">Assistant published successfully</p>`;
                
                // Reset the form
                event.target.reset();
            } catch (error) {
                console.error('Error publishing assistant:', error);
                console.error('Error details:', JSON.stringify(error.response?.data, null, 2));
                let errorMessage = error.response?.data?.detail;
                if (Array.isArray(errorMessage)) {
                    errorMessage = errorMessage.map(err => {
                        if (typeof err === 'object') {
                            return `${err.loc.join('.')}: ${err.msg}`;
                        }
                        return err;
                    }).join('\n');
                }
                document.getElementById('editAssistantResponse').innerHTML = 
                    `<pre style="color: red; white-space: pre-wrap;">Error publishing assistant:\n${errorMessage || error.message}</pre>`;
            } finally {
                // Reset button state
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
                console.log('Form submission completed');
            }
        }

        function showPublishModal() {
            const assistantId = document.getElementById('assistantSelect').value;
            console.log('Show publish modal for assistant:', assistantId);
            if (!assistantId) {
                alert('Please select an assistant first');
                return;
            }
            const modal = document.getElementById('publishModal');
            if (!modal) {
                console.error('Publish modal not found');
                return;
            }
            modal.style.display = 'flex';
            document.getElementById('publishForm').reset();
            document.getElementById('editAssistantResponse').innerHTML = '';
            console.log('Publish modal displayed');
        }

        function closePublishModal() {
            document.getElementById('publishModal').style.display = 'none';
        }

        async function loadAssistants() {
            const apiKey = document.getElementById('apiKey').value;
            
            try {
                // Get all assistants
                const response = await axios.get(
                    '/lamb/v1/assistant/get_list_of_all_assistants',
                    {
                        headers: { 'Authorization': `Bearer ${apiKey}` }
                    }
                );

                const tbody = document.getElementById('editAssistantsBody');
                tbody.innerHTML = '';

                if (response.data && Array.isArray(response.data.assistants)) {
                    response.data.assistants.forEach(assistant => {
                        const row = document.createElement('tr');
                        
                        // Determine if assistant is published
                        const isPublished = assistant.group_id != null;
                        
                        row.innerHTML = `
                            <td>${assistant.name}</td>
                            <td>${assistant.owner}</td>
                            <td>
                                <span style="
                                    padding: 4px 8px;
                                    border-radius: 4px;
                                    background-color: ${isPublished ? '#4CAF50' : '#FF9800'};
                                    color: white;
                                ">
                                    ${isPublished ? `Published (${assistant.group_name})` : 'Unpublished'}
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="icon-button action-inspect" 
                                            onclick="duplicateAssistant(${assistant.id})"
                                            style="background-color: #2196F3;"
                                            data-tooltip="Duplicate">
                                        â§
                                    </button>
                                    ${!isPublished ? `
                                        <button class="icon-button action-publish" 
                                                onclick="showPublishModal(${assistant.id})"
                                                style="background-color: #4CAF50;"
                                                data-tooltip="Publish">
                                            ð¤
                                        </button>
                                        <button class="icon-button action-delete" 
                                                onclick="confirmDelete(${assistant.id})"
                                                style="background-color: #f44336;"
                                                data-tooltip="Delete">
                                            ð
                                        </button>
                                    ` : `
                                        <button class="icon-button action-delete" 
                                                onclick="softDeleteAssistant(${assistant.id})"
                                                style="background-color: #FF9800;"
                                                data-tooltip="Soft Delete">
                                            ðï¸
                                        </button>
                                    `}
                                </div>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="4" style="text-align: center;">No assistants found</td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Error loading assistants:', error);
                document.getElementById('editAssistantResponse').innerHTML = 
                    `<p style="color: red;">Error loading assistants: ${error.response?.data?.detail || error.message}</p>`;
            }
        }

        async function loadAssistantDetails(assistantId) {
            const apiKey = document.getElementById('apiKey').value;
            try {
                const response = await axios.get(
                    `/lamb/v1/assistant/get_assistant_by_id/${assistantId}`,
                    {
                        headers: { 'Authorization': `Bearer ${apiKey}` }
                    }
                );

                if (response.data && response.data.assistant) {
                    const assistant = response.data.assistant;
                    
                    // Populate form fields
                    document.getElementById('editAssistantId').value = assistant.id;
                    document.getElementById('editAssistantName').value = assistant.name;
                    document.getElementById('editAssistantName').dataset.originalName = assistant.name;
                    document.getElementById('editAssistantDescription').value = assistant.description;
                    document.getElementById('editAssistantSystemPrompt').value = assistant.system_prompt;
                    document.getElementById('editAssistantPromptTemplate').value = assistant.prompt_template;
                    document.getElementById('editAssistantApiCallback').value = assistant.metadata || assistant.api_callback || '';
                    document.getElementById('editAssistantRAGEndpoint').value = assistant.RAG_endpoint;
                    document.getElementById('editAssistantRAGTopK').value = assistant.RAG_Top_k;
                    document.getElementById('editAssistantPreRetrievalEndpoint').value = assistant.pre_retrieval_endpoint;
                    document.getElementById('editAssistantPostRetrievalEndpoint').value = assistant.post_retrieval_endpoint;

                    // Show the edit form
                    document.getElementById('assistantDetails').style.display = 'block';
                    
                    // Scroll to the form
                    document.getElementById('assistantDetails').scrollIntoView({ behavior: 'smooth' });
                }
            } catch (error) {
                console.error('Error loading assistant details:', error);
                alert('Error loading assistant details: ' + (error.response?.data?.detail || error.message));
            }
        }

        async function createAssistant(event) {
            if (event) event.preventDefault();
            
            // Debug logs for each field
            console.log('Debug - Form Fields:');
            const fields = [
                'apiKey',
                'userDisplayName',
                'assistantName',
                'assistantDescription',
                'assistantSystemPrompt',
                'assistantPromptTemplate',
                'assistantRAGEndpoint',
                'assistantRAGTopK',
                'assistantPreRetrievalEndpoint',
                'assistantPostRetrievalEndpoint',
                'assistantRAGCollections'
            ];
            
            const formValues = {};
            fields.forEach(field => {
                const element = document.getElementById(field);
                console.log(`${field}:`, element ? 'Found' : 'Not Found', element?.value);
                formValues[field] = element?.value;
            });

            const apiKey = formValues.apiKey;
            const userEmail = document.getElementById('userDisplayName')?.textContent;
            console.log('userEmail:', userEmail);
            
            // Get selected collections from the multi-select
            const select = document.getElementById('assistantRAGCollections');
            console.log('RAG Collections select:', select ? 'Found' : 'Not Found');
            const selectedCollections = select ? Array.from(select.selectedOptions).map(option => option.value) : [];
            console.log('Selected collections:', selectedCollections);

            const requestData = {
                name: formValues.assistantName,
                description: formValues.assistantDescription,
                owner: userEmail,
                system_prompt: formValues.assistantSystemPrompt,
                prompt_template: formValues.assistantPromptTemplate,
                api_callback: '',  // DEPRECATED: Use metadata instead, but kept for backend compatibility
                RAG_endpoint: formValues.assistantRAGEndpoint,
                RAG_Top_k: parseInt(formValues.assistantRAGTopK) || 5,
                RAG_collections: selectedCollections.join(','),
                pre_retrieval_endpoint: formValues.assistantPreRetrievalEndpoint,
                post_retrieval_endpoint: formValues.assistantPostRetrievalEndpoint
            };

            console.log('Request payload:', requestData);

            try {
                const response = await axios.post(
                    '/lamb/v1/assistant/create_assistant',
                    requestData,
                    {
                        headers: { 'Authorization': `Bearer ${apiKey}` }
                    }
                );

                console.log('Server response:', response.data);

                if (response.data.assistant_id) {
                    // Clear form
                    fields.forEach(field => {
                        const element = document.getElementById(field);
                        if (element && field !== 'apiKey' && field !== 'userDisplayName') {
                            element.value = '';
                        }
                    });

                    // Clear multi-select
                    const select = document.getElementById('assistantRAGCollections');
                    if (select) Array.from(select.options).forEach(option => option.selected = false);

                    // Show success message in the response div
                    document.getElementById('createAssistantResponse').innerHTML = 
                        `<p style="color: green; margin-top: 10px;">Assistant created successfully! ID: ${response.data.assistant_id}</p>`;

                    // Refresh the list if we're in edit mode
                    loadAssistants();
                } else {
                    document.getElementById('createAssistantResponse').innerHTML = 
                        `<p style="color: red; margin-top: 10px;">Error creating assistant: Unexpected response format</p>`;
                }
            } catch (error) {
                console.error('Error creating assistant:', error);
                console.error('Error details:', error.response?.data);
                const errorMessage = error.response?.data?.detail || error.message;
                // Remove the "Internal server error: 500:" prefix if it exists
                const cleanErrorMessage = errorMessage.replace(/^Internal server error: \d+: /, '');
                document.getElementById('createAssistantResponse').innerHTML = 
                    `<p style="color: red; margin-top: 10px;">Error creating assistant: ${cleanErrorMessage}</p>`;
            }
        }

        async function getAssistant(event) {
            event.preventDefault();
            const apiKey = document.getElementById('apiKey').value;
            const assistantId = document.getElementById('assistantId').value;

            try {
                const response = await axios.get(`/lamb/v1/assistant/get_assistant_by_id/${assistantId}`, {
                    headers: { 'Authorization': `Bearer ${apiKey}` }
                });
                const assistant = response.data.assistant;
                document.getElementById('getAssistantResponse').innerHTML = `
                    <h3>Assistant Details:</h3>
                    <p>ID: ${assistant.id}</p>
                    <p>Name: ${assistant.name}</p>
                    <p>Description: ${assistant.description}</p>
                    <p>Owner: ${assistant.owner}</p>
                    <p>Metadata: ${assistant.metadata || assistant.api_callback || 'None'}</p>
                    <p>System Prompt: ${assistant.system_prompt}</p>
                    <p>Prompt Template: ${assistant.prompt_template}</p>
                    <p>Pre-Retrieval Endpoint: ${assistant.pre_retrieval_endpoint}</p>
                    <p>Post-Retrieval Endpoint: ${assistant.post_retrieval_endpoint}</p>
                    <p>LLM: ${assistant.llm}</p>
                `;
            } catch (error) {
                document.getElementById('getAssistantResponse').innerHTML = `Error getting assistant: ${error.response.data.detail}`;
            }
        }

        async function getAssistantByName(event) {
            event.preventDefault();
            const apiKey = document.getElementById('apiKey').value;
            const name = document.getElementById('getAssistantName').value;
            const owner = document.getElementById('getAssistantOwner').value;

            try {
                const response = await axios.get(
                    `/lamb/v1/assistant/get_assistant_by_name/${encodeURIComponent(name)}?owner=${encodeURIComponent(owner)}`,
                    {
                        headers: { 'Authorization': `Bearer ${apiKey}` }
                    }
                );
                const assistant = response.data.assistant;
                document.getElementById('getAssistantByNameResponse').innerHTML = `
                    <h3>Assistant Details:</h3>
                    <pre>${JSON.stringify(assistant, null, 2)}</pre>
                `;
                // Show delete button when assistant is found
                document.getElementById('deleteSection').style.display = 'block';
                // Store assistant ID for delete operation
                document.getElementById('deleteSection').dataset.assistantId = assistant.id;
                document.getElementById('deleteSection').dataset.assistantOwner = assistant.owner;
            } catch (error) {
                document.getElementById('getAssistantByNameResponse').innerHTML = 
                    `Error getting assistant: ${error.response ? error.response.data.detail : error.message}`;
                // Hide delete button if there's an error
                document.getElementById('deleteSection').style.display = 'none';
            }
        }

        async function getAssistantsList(event) {
            event.preventDefault();
            const apiKey = document.getElementById('apiKey').value;
            const owner = document.getElementById('ownerListGet').value;

            try {
                const response = await axios.get(`/lamb/v1/assistant/get_list_of_assistants/${encodeURIComponent(owner)}`, {
                    headers: { 'Authorization': `Bearer ${apiKey}` }
                });
                const assistants = response.data.assistants;
                let assistantsList = '<h3>Assistants List:</h3><ul>';
                assistants.forEach(assistant => {
                    assistantsList += `
                        <li>
                            <strong>Name:</strong> ${assistant.name}<br>
                            <strong>ID:</strong> ${assistant.id}<br>
                            <strong>Description:</strong> ${assistant.description}<br>
                            <strong>Owner:</strong> ${assistant.owner}
                        </li>
                    `;
                });
                assistantsList += '</ul>';
                document.getElementById('getAssistantsListResponse').innerHTML = assistantsList;
            } catch (error) {
                document.getElementById('getAssistantsListResponse').innerHTML = `Error getting assistants list: ${error.response ? error.response.data.detail : error.message}`;
            }
        }

        async function deleteAssistant(assistantId, owner) {
            const apiKey = document.getElementById('apiKey').value;
            
            console.log('Deleting assistant:', { assistantId, owner }); // Add logging

            try {
                const response = await axios.delete(
                    `/lamb/v1/assistant/delete_assistant/${assistantId}?owner=${encodeURIComponent(owner)}`,
                    {
                        headers: { 'Authorization': `Bearer ${apiKey}` }
                    }
                );
                
                console.log('Delete response:', response.data); // Add logging
                
                // Handle success message for both locations
                const editResponse = document.getElementById('editAssistantResponse');
                const getByNameResponse = document.getElementById('getAssistantByNameResponse');
                
                const successMessage = `<p style="color: green;">Assistant deleted successfully</p>`;
                
                if (editResponse.offsetParent !== null) {
                    // Edit section is visible
                    editResponse.innerHTML = successMessage;
                    
                    // Reset everything in the edit section
                    document.getElementById('editAssistantForm').reset();
                    document.getElementById('assistantDetails').style.display = 'none';
                    
                    // Clear and reset the select dropdown
                    const select = document.getElementById('assistantSelect');
                    select.value = '';
                    
                    // Clear all form fields
                    document.querySelectorAll('#editAssistantForm input, #editAssistantForm textarea').forEach(element => {
                        element.value = '';
                    });
                    
                    // Reset button states
                    document.getElementById('duplicateButton').disabled = true;
                    document.getElementById('deleteButton').disabled = true;
                    document.getElementById('updateButton').disabled = true;
                    
                    // Reset helper text
                    document.getElementById('nameHelperText').textContent = 'Select an assistant to edit';
                    
                    // Reload the assistants list
                    await loadAssistants();
                    
                    // After a short delay, clear the success message and show select prompt
                    setTimeout(() => {
                        editResponse.innerHTML = '<p>Please select an assistant to edit</p>';
                    }, 2000);
                    
                } else {
                    // Get-by-name section is visible
                    getByNameResponse.innerHTML = successMessage;
                    document.getElementById('deleteSection').style.display = 'none';
                    document.getElementById('getAssistantByNameForm').reset();
                    
                    // After a short delay, clear the success message
                    setTimeout(() => {
                        getByNameResponse.innerHTML = '';
                    }, 2000);
                }
            } catch (error) {
                console.error('Delete error:', error); // Add logging
                const errorMessage = `<p style="color: red;">Error deleting assistant: ${error.response?.data?.detail || error.message}</p>`;
                
                if (document.getElementById('editAssistantResponse').offsetParent !== null) {
                    document.getElementById('editAssistantResponse').innerHTML = errorMessage;
                } else {
                    document.getElementById('getAssistantByNameResponse').innerHTML = errorMessage;
                }
            }
        }

        async function getAllAssistants(event) {
            event.preventDefault();
            const apiKey = document.getElementById('apiKey').value;

            try {
                const response = await axios.get('/lamb/v1/assistant/get_list_of_all_assistants', {
                    headers: { 'Authorization': `Bearer ${apiKey}` }
                });
                const assistants = response.data.assistants;
                let assistantsList = '<h3>All Assistants:</h3><ul>';
                assistants.forEach(assistant => {
                    assistantsList += `
                        <li>
                            <strong>Name:</strong> ${assistant.name}<br>
                            <strong>ID:</strong> ${assistant.id}<br>
                            <strong>Description:</strong> ${assistant.description}<br>
                            <strong>Owner:</strong> ${assistant.owner}
                        </li>
                    `;
                });
                assistantsList += '</ul>';
                document.getElementById('getAllAssistantsResponse').innerHTML = assistantsList;
            } catch (error) {
                document.getElementById('getAllAssistantsResponse').innerHTML = `Error getting all assistants: ${error.response.data.detail}`;
            }
        }

        // Separate the edit form submit handler
        async function handleEditAssistantSubmit(event) {
            event.preventDefault();
            const apiKey = document.getElementById('apiKey').value;
            const assistantId = document.getElementById('assistantSelect').value;
            
            // Get selected collections from the multi-select
            const editSelect = document.getElementById('editAssistantRAGCollections');
            const selectedCollections = Array.from(editSelect.selectedOptions).map(option => option.value);
            
            const assistantData = {
                id: assistantId,
                name: document.getElementById('editAssistantName').value,
                description: document.getElementById('editAssistantDescription').value,
                owner: document.getElementById('userDisplayName').textContent,
                api_callback: document.getElementById('editAssistantApiCallback').value || '',  // DEPRECATED: Use metadata instead
                system_prompt: document.getElementById('editAssistantSystemPrompt').value,
                prompt_template: document.getElementById('editAssistantPromptTemplate').value,
                pre_retrieval_endpoint: document.getElementById('editAssistantPreRetrievalEndpoint').value,
                post_retrieval_endpoint: document.getElementById('editAssistantPostRetrievalEndpoint').value,
                RAG_endpoint: document.getElementById('editAssistantRAGEndpoint').value,
                RAG_Top_k: parseInt(document.getElementById('editAssistantRAGTopK').value) || 5,
                RAG_collections: selectedCollections.join(',')
            };

            try {
                const response = await axios.put(
                    `/lamb/v1/assistant/update_assistant/${assistantId}`, 
                    assistantData,
                    {
                        headers: { 'Authorization': `Bearer ${apiKey}` }
                    }
                );
                document.getElementById('editAssistantResponse').innerHTML = 
                    '<p style="color: green; margin-top: 10px;">Assistant updated successfully</p>';
                await loadAssistants(); // Refresh the list
            } catch (error) {
                console.error('Error updating assistant:', error);
                const errorMessage = error.response?.data?.detail || error.message;
                // Remove the "Internal server error: 500:" prefix if it exists
                const cleanErrorMessage = errorMessage.replace(/^Internal server error: \d+: /, '');
                document.getElementById('editAssistantResponse').innerHTML = 
                    `<p style="color: red; margin-top: 10px;">Error updating assistant: ${cleanErrorMessage}</p>`;
            }
        }

        async function duplicateAssistant() {
            const apiKey = document.getElementById('apiKey').value;
            const currentName = document.getElementById('editAssistantName').value;
            
            // Create new assistant data from current form values
            const assistantData = {
                name: currentName, // Use the modified name directly
                description: document.getElementById('editAssistantDescription').value,
                owner: document.getElementById('userDisplayName').textContent,
                api_callback: document.getElementById('editAssistantApiCallback').value,  // DEPRECATED: Use metadata instead
                system_prompt: document.getElementById('editAssistantSystemPrompt').value,
                prompt_template: document.getElementById('editAssistantPromptTemplate').value,
                pre_retrieval_endpoint: document.getElementById('editAssistantPreRetrievalEndpoint').value,
                post_retrieval_endpoint: document.getElementById('editAssistantPostRetrievalEndpoint').value,
                RAG_endpoint: document.getElementById('editAssistantRAGEndpoint').value,
                RAG_Top_k: parseInt(document.getElementById('editAssistantRAGTopK').value),
                RAG_collections: document.getElementById('editAssistantRAGCollections').value
            };

            try {
                // Create the new assistant
                const response = await axios.post('/lamb/v1/assistant/create_assistant', assistantData, {
                    headers: { 'Authorization': `Bearer ${apiKey}` }
                });
                
                // Refresh the assistants list
                await loadAssistants();
                
                // Select the new assistant
                const select = document.getElementById('assistantSelect');
                select.value = response.data.assistant_id;
                
                // Load the details of the new assistant to reset the form state
                await loadAssistantDetails();
                
                // Show success message
                document.getElementById('editAssistantResponse').innerHTML = 
                    `Assistant created successfully. New ID: ${response.data.assistant_id}`;
                    
            } catch (error) {
                document.getElementById('editAssistantResponse').innerHTML = 
                    `Error creating assistant: ${error.response?.data?.detail || error.message}`;
            }
        }

        // Add this function to detect name changes
        function handleNameChange() {
            const originalName = document.getElementById('editAssistantName').dataset.originalName;
            const currentName = document.getElementById('editAssistantName').value;
            const isDifferentName = originalName !== currentName && currentName.trim() !== '';
            
            // Enable/disable buttons based on name change
            document.getElementById('duplicateButton').disabled = !isDifferentName;
            document.getElementById('updateButton').disabled = isDifferentName;
            document.getElementById('deleteButton').disabled = isDifferentName;
            
            // Update helper text
            document.getElementById('nameHelperText').textContent = isDifferentName ? 
                'Click Duplicate to create a new assistant with this name' : 
                'Change the name to create a duplicate assistant';
        }

        // Add confirmation dialog function
        function confirmDelete() {
            const deleteButton = document.getElementById('deleteButton');
            const deleteSection = document.getElementById('deleteSection');
            
            const assistantId = deleteButton.dataset.assistantId || deleteSection.dataset.assistantId;
            const owner = deleteButton.dataset.assistantOwner || deleteSection.dataset.assistantOwner;
            
            console.log('Delete assistant:', { assistantId, owner }); // Add logging
            
            if (!assistantId || !owner) {
                alert('Error: Missing assistant ID or owner');
                return;
            }
            
            if (confirm('Are you sure you want to delete this assistant? This action cannot be undone.')) {
                deleteAssistant(assistantId, owner);
            }
        }

        async function loadPublishedAssistants() {
            const apiKey = document.getElementById('apiKey').value;
            
            try {
                const response = await axios.get(
                    `/lamb/v1/assistant/get_published_assistants`,
                    {
                        headers: { 'Authorization': `Bearer ${apiKey}` }
                    }
                );
                
                const tbody = document.getElementById('publishedAssistantsBody');
                tbody.innerHTML = '';
                
                if (response.data && Array.isArray(response.data)) {
                    response.data.forEach(assistant => {
                        const row = document.createElement('tr');
                        const createdDate = new Date(assistant.created_at * 1000).toLocaleString();
                        
                        row.innerHTML = `
                            <td>${assistant.assistant_name}</td>
                            <td>${assistant.group_name}</td>
                            <td>${assistant.oauth_consumer_name}</td>
                            <td>${createdDate}</td>
                            <td>${assistant.assistant_owner}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="icon-button action-inspect" 
                                            onclick="inspectAssistant(${assistant.assistant_id})"
                                            style="background-color: #4CAF50;"
                                            data-tooltip="Inspect">
                                        ð
                                    </button>
                                    ${assistant.group_id ? `
                                        <button class="icon-button action-users" 
                                                onclick="listGroupUsers('${assistant.group_id}', '${assistant.group_name}')"
                                                style="background-color: #2196F3;"
                                                data-tooltip="Users">
                                            ð¥
                                        </button>
                                        <button class="icon-button action-publish" 
                                                onclick="unpublishAssistant(${assistant.id}, '${assistant.group_id}')"
                                                style="background-color: #f44336;"
                                                data-tooltip="Unpublish">
                                            ð
                                        </button>
                                    ` : ''}
                                    <button class="icon-button action-delete" 
                                            onclick="softDeleteAssistant(${assistant.id})"
                                            style="background-color: #FF9800;"
                                            data-tooltip="Soft Delete">
                                        ðï¸
                                    </button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    document.getElementById('publishedAssistantsResponse').innerHTML = 
                        '<p>No published assistants found.</p>';
                }
            } catch (error) {
                console.error('Error loading published assistants:', error);
                document.getElementById('publishedAssistantsResponse').innerHTML = 
                    `<p style="color: red;">Error loading published assistants: ${error.response?.data?.detail || error.message}</p>`;
            }
        }

        async function unpublishAssistant(assistantId, groupId) {
            if (!confirm('Are you sure you want to unpublish this assistant?')) {
                return;
            }

            const apiKey = document.getElementById('apiKey').value;
            const userEmail = document.getElementById('userDisplayName').textContent;
            
            try {
                await axios.delete(
                    `/lamb/v1/assistant/unpublish_assistant/${assistantId}/${groupId}?user_email=${encodeURIComponent(userEmail)}`,
                    {
                        headers: { 'Authorization': `Bearer ${apiKey}` }
                    }
                );
                
                document.getElementById('publishedAssistantsResponse').innerHTML = 
                    '<p style="color: green;">Assistant unpublished successfully</p>';
                
                // Reload the published assistants list
                await loadPublishedAssistants();
            } catch (error) {
                console.error('Error unpublishing assistant:', error);
                document.getElementById('publishedAssistantsResponse').innerHTML = 
                    `<p style="color: red;">Error unpublishing assistant: ${error.response?.data?.detail || error.message}</p>`;
            }
        }

        async function inspectAssistant(assistantId) {
            const apiKey = document.getElementById('apiKey').value;
            try {
                const response = await axios.get(
                    `/lamb/v1/assistant/get_assistant_by_id/${assistantId}`,
                    {
                        headers: { 'Authorization': `Bearer ${apiKey}` }
                    }
                );
                
                const assistant = response.data.assistant;
                const content = `
                    <div style="padding: 20px;">
                        <h4>Basic Information</h4>
                        <p><strong>Name:</strong> ${assistant.name}</p>
                        <p><strong>Description:</strong> ${assistant.description}</p>
                        <p><strong>Owner:</strong> ${assistant.owner}</p>
                        
                        <h4>Configuration</h4>
                        <p><strong>Metadata:</strong> ${assistant.metadata || assistant.api_callback || 'None'}</p>
                        <p><strong>RAG Endpoint:</strong> ${assistant.RAG_endpoint}</p>
                        <p><strong>RAG Top K:</strong> ${assistant.RAG_Top_k}</p>
                        <p><strong>RAG Collections:</strong> ${assistant.RAG_collections}</p>
                        
                        <h4>Prompts</h4>
                        <div style="background: #f5f5f5; padding: 10px; margin: 5px 0; border-radius: 4px;">
                            <strong>System Prompt:</strong><br>
                            <pre style="white-space: pre-wrap;">${assistant.system_prompt}</pre>
                        </div>
                        <div style="background: #f5f5f5; padding: 10px; margin: 5px 0; border-radius: 4px;">
                            <strong>Prompt Template:</strong><br>
                            <pre style="white-space: pre-wrap;">${assistant.prompt_template}</pre>
                        </div>
                    </div>
                `;
                
                document.getElementById('inspectContent').innerHTML = content;
                document.getElementById('inspectModal').style.display = 'flex';
            } catch (error) {
                console.error('Error inspecting assistant:', error);
                alert('Error loading assistant details: ' + (error.response?.data?.detail || error.message));
            }
        }

        async function listGroupUsers(groupId, groupName) {
            const apiKey = document.getElementById('apiKey').value;
            try {
                const response = await axios.get(
                    `/lamb/v1/OWI/get_group_users/${groupId}`,
                    {
                        headers: { 'Authorization': `Bearer ${apiKey}` }
                    }
                );
                
                let content = `<div style="padding: 20px;">
                    <h4>Users in group: ${groupName}</h4>`;
                
                const users = response.data?.data;  // Response is wrapped in {status: "success", data: [...]}
                if (users && users.length > 0) {
                    content += '<table class="users-table" style="width: 100%;">';
                    content += '<tr><th>Name</th><th>Email</th></tr>';
                    users.forEach(user => {
                        content += `<tr>
                            <td>${user.name || 'N/A'}</td>
                            <td>${user.email}</td>
                        </tr>`;
                    });
                    content += '</table>';
                } else {
                    content += '<p>No users found in this group.</p>';
                }
                
                content += '</div>';
                document.getElementById('usersContent').innerHTML = content;
                document.getElementById('usersModal').style.display = 'flex';
            } catch (error) {
                console.error('Error listing group users:', error);
                const errorMessage = error.response?.data?.error || error.response?.data?.detail || error.message;
                alert('Error loading group users: ' + (error.response?.data?.detail || error.message));
            }
        }

        function closeInspectModal() {
            document.getElementById('inspectModal').style.display = 'none';
        }

        function closeUsersModal() {
            document.getElementById('usersModal').style.display = 'none';
        }

        // Add this function to fetch and populate collections
        async function loadChromaCollections() {
            try {
                // First fetch the knowledge bases to get their names
                const kbResponse = await fetch('/lamb/v1/chromadb/');
                const kbData = await kbResponse.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(kbData, 'text/html');
                const kbMap = {};
                doc.querySelectorAll('.collection-card').forEach(card => {
                    // Find the div containing the ID (it's in a div with text-sm text-gray-500 class)
                    const idText = card.querySelector('.text-sm.text-gray-500 p:first-child').textContent;
                    const id = idText.split(':')[1].trim().split('...')[0].trim();
                    const name = card.querySelector('h3').textContent.trim();
                    kbMap[id] = name;
                });

                const response = await fetch('/lamb/v1/chromadb/api/collections');
                const data = await response.json();
                
                const select = document.getElementById('assistantRAGCollections');
                const editSelect = document.getElementById('editAssistantRAGCollections');
                
                // Clear existing options
                select.innerHTML = '';
                editSelect.innerHTML = '';
                
                if (data.chroma_collections && data.chroma_collections.length > 0) {
                    // Filter out collections with "file-" prefix and format display text
                    const filteredCollections = data.chroma_collections
                        .filter(collection => !collection.name.startsWith('file-'))
                        .map(collection => {
                            // Take the first 8 characters of the collection name (the first part of the UUID)
                            const uuid = collection.name.substring(0, 8);
                            
                            // Check if this collection belongs to a KB by looking it up in kbMap
                            if (kbMap[uuid]) {
                                const displayName = `${kbMap[uuid]} (${uuid}...) (${collection.count} documents)`;
                                return {
                                    value: collection.name,
                                    display: displayName
                                };
                            }
                            
                            // For collections not associated with a KB, keep the original format
                            return {
                                value: collection.name,
                                display: `${collection.name} (${collection.count} documents)`
                            };
                        });

                    filteredCollections.forEach(collection => {
                        const option = document.createElement('option');
                        option.value = collection.value;
                        option.textContent = collection.display;
                        
                        // Add to both create and edit forms
                        select.appendChild(option.cloneNode(true));
                        editSelect.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "No collections available";
                    option.disabled = true;
                    
                    select.appendChild(option.cloneNode(true));
                    editSelect.appendChild(option);
                }
            } catch (error) {
                console.error('Error loading collections:', error);
                const errorOption = document.createElement('option');
                errorOption.value = "";
                errorOption.textContent = "Error loading collections";
                errorOption.disabled = true;
                
                document.getElementById('assistantRAGCollections').innerHTML = '';
                document.getElementById('editAssistantRAGCollections').innerHTML = '';
                document.getElementById('assistantRAGCollections').appendChild(errorOption.cloneNode(true));
                document.getElementById('editAssistantRAGCollections').appendChild(errorOption);
            }
        }

        async function editAssistant(assistant) {
            // Populate edit form fields
            document.getElementById('editAssistantId').value = assistant.id;
            document.getElementById('editAssistantName').value = assistant.name;
            document.getElementById('editAssistantDescription').value = assistant.description;
            document.getElementById('editAssistantSystemPrompt').value = assistant.system_prompt;
            document.getElementById('editAssistantPromptTemplate').value = assistant.prompt_template;
            document.getElementById('editAssistantAPICallback').value = assistant.metadata || assistant.api_callback || '';
            document.getElementById('editAssistantRAGEndpoint').value = assistant.RAG_endpoint;
            document.getElementById('editAssistantRAGTopK').value = assistant.RAG_Top_k;
            document.getElementById('editAssistantPreRetrievalEndpoint').value = assistant.pre_retrieval_endpoint;
            document.getElementById('editAssistantPostRetrievalEndpoint').value = assistant.post_retrieval_endpoint;

            // Handle RAG collections
            const editSelect = document.getElementById('editAssistantRAGCollections');
            if (assistant.RAG_collections) {
                // Wait for collections to be loaded
                await loadChromaCollections();
                
                // Get the array of collections
                const collections = assistant.RAG_collections.split(',').map(c => c.trim()).filter(c => c);
                
                // Select the collections in the multi-select
                Array.from(editSelect.options).forEach(option => {
                    option.selected = collections.includes(option.value);
                });
            }

            // Show edit modal
            document.getElementById('editModal').style.display = 'flex';
        }

        async function updateAssistant() {
            const apiKey = document.getElementById('apiKey').value;
            const assistantId = document.getElementById('editAssistantId').value;
            
            // Get selected collections
            const editSelect = document.getElementById('editAssistantRAGCollections');
            const selectedCollections = Array.from(editSelect.selectedOptions).map(option => option.value);

            try {
                const response = await axios.put(
                    `/lamb/v1/assistant/update_assistant/${assistantId}`,
                    {
                        name: document.getElementById('editAssistantName').value,
                        description: document.getElementById('editAssistantDescription').value,
                        system_prompt: document.getElementById('editAssistantSystemPrompt').value,
                        prompt_template: document.getElementById('editAssistantPromptTemplate').value,
                        api_callback: document.getElementById('editAssistantAPICallback').value || '',  // DEPRECATED: Use metadata instead
                        RAG_endpoint: document.getElementById('editAssistantRAGEndpoint').value,
                        RAG_Top_k: parseInt(document.getElementById('editAssistantRAGTopK').value) || 5,
                        RAG_collections: selectedCollections.join(','),
                        pre_retrieval_endpoint: document.getElementById('editAssistantPreRetrievalEndpoint').value,
                        post_retrieval_endpoint: document.getElementById('editAssistantPostRetrievalEndpoint').value
                    },
                    {
                        headers: { 'Authorization': `Bearer ${apiKey}` }
                    }
                );

                if (response.data.success) {
                    closeEditModal();
                    loadAssistants(); // Refresh the list
                } else {
                    alert('Error updating assistant: ' + response.data.error);
                }
            } catch (error) {
                console.error('Error updating assistant:', error);
                alert('Error updating assistant: ' + (error.response?.data?.detail || error.message));
            }
        }

        // Function to load creator users into select dropdown
        async function loadCreatorUsers() {
            const apiKey = document.getElementById('apiKey').value;
            
            try {
                const response = await axios.get(
                    '/lamb/v1/creator_user/list',
                    {
                        headers: { 'Authorization': `Bearer ${apiKey}` }
                    }
                );
                
                const select = document.getElementById('creatorSelect');
                select.innerHTML = '<option value="">Select a creator</option>';
                
                if (response.data && Array.isArray(response.data)) {
                    response.data.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.email;
                        option.textContent = `${user.name} (${user.email})`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading creator users:', error);
                document.getElementById('creatorPublishedAssistantsResponse').innerHTML = 
                    `<p style="color: red;">Error loading creator users: ${error.response?.data?.detail || error.message}</p>`;
            }
        }

        // Function to load published assistants for selected creator
        async function loadCreatorPublishedAssistants() {
            const apiKey = document.getElementById('apiKey').value;
            const creatorEmail = document.getElementById('creatorSelect').value;
            
            if (!creatorEmail) {
                document.getElementById('creatorPublishedAssistantsBody').innerHTML = '';
                return;
            }
            
            try {
                const response = await axios.get(
                    `/lamb/v1/assistant/get_assistants_by_owner/${encodeURIComponent(creatorEmail)}`,
                    {
                        headers: { 'Authorization': `Bearer ${apiKey}` }
                    }
                );
                
                // Add debug information
                document.getElementById('debugContent').innerHTML = 
                    `Endpoint: /lamb/v1/assistant/get_assistants_by_owner/${encodeURIComponent(creatorEmail)}\n\n` +
                    `Response Data:\n${JSON.stringify(response.data, null, 2)}`;
                
                const tbody = document.getElementById('creatorPublishedAssistantsBody');
                tbody.innerHTML = '';
                
                if (response.data && Array.isArray(response.data)) {
                    response.data.forEach(assistant => {
                        const row = document.createElement('tr');
                        const createdDate = assistant.published_at ? 
                            new Date(assistant.published_at * 1000).toLocaleString() : 
                            'Not published';
                        
                        row.innerHTML = `
                            <td>${assistant.name}</td>
                            <td>${assistant.group_name || 'N/A'}</td>
                            <td>${assistant.oauth_consumer_name || 'N/A'}</td>
                            <td>${createdDate}</td>
                            <td>${assistant.owner}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="icon-button action-inspect" 
                                            onclick="inspectAssistant(${assistant.id})"
                                            style="background-color: #4CAF50;"
                                            data-tooltip="Inspect">
                                        ð
                                    </button>
                                    ${assistant.group_id ? `
                                        <button class="icon-button action-users" 
                                                onclick="listGroupUsers('${assistant.group_id}', '${assistant.group_name}')"
                                                style="background-color: #2196F3;"
                                                data-tooltip="Users">
                                            ð¥
                                        </button>
                                        <button class="icon-button action-publish" 
                                                onclick="unpublishAssistant(${assistant.id}, '${assistant.group_id}')"
                                                style="background-color: #f44336;"
                                                data-tooltip="Unpublish">
                                            ð
                                        </button>
                                    ` : ''}
                                    <button class="icon-button action-delete" 
                                            onclick="softDeleteAssistant(${assistant.id})"
                                            style="background-color: #FF9800;"
                                            data-tooltip="Soft Delete">
                                        ðï¸
                                    </button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    document.getElementById('creatorPublishedAssistantsResponse').innerHTML = 
                        '<p>No assistants found for this creator.</p>';
                }
            } catch (error) {
                console.error('Error loading creator assistants:', error);
                // Add error to debug information
                document.getElementById('debugContent').innerHTML = 
                    `Endpoint: /lamb/v1/assistant/get_assistants_by_owner/${encodeURIComponent(creatorEmail)}\n\n` +
                    `Error:\n${JSON.stringify(error.response?.data || error.message, null, 2)}`;
                    
                document.getElementById('creatorPublishedAssistantsResponse').innerHTML = 
                    `<p style="color: red;">Error loading assistants: ${error.response?.data?.detail || error.message}</p>`;
            }
        }

        async function softDeleteAssistant(assistantId) {
            if (!confirm('Are you sure you want to soft delete this assistant? This will transfer ownership to admin and remove users from the group.')) {
                return;
            }

            const apiKey = document.getElementById('apiKey').value;
            
            try {
                await axios.delete(
                    `/lamb/v1/assistant/soft_delete_assistant/${assistantId}`,
                    {
                        headers: { 'Authorization': `Bearer ${apiKey}` }
                    }
                );
                
                document.getElementById('creatorPublishedAssistantsResponse').innerHTML = 
                    '<p style="color: green;">Assistant soft deleted successfully</p>';
                
                // Reload the creator's published assistants list
                await loadCreatorPublishedAssistants();
                
                // Clear the message after 3 seconds
                setTimeout(() => {
                    document.getElementById('creatorPublishedAssistantsResponse').innerHTML = '';
                }, 3000);
            } catch (error) {
                console.error('Error soft deleting assistant:', error);
                document.getElementById('creatorPublishedAssistantsResponse').innerHTML = 
                    `<p style="color: red;">Error soft deleting assistant: ${error.response?.data?.detail || error.message}</p>`;
            }
        }
    </script>
</body>
</html>
