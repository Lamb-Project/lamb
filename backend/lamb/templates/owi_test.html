<!DOCTYPE html>
<html>
<head>
    <title>OWI API Test Interface</title>
    <link rel="stylesheet" href="/static/css/lamb.css">
    <style>
        #group-details-sidebar {
            position: fixed;
            right: 0;
            top: 50px; /* Adjust based on your top bar height */
            width: 300px;
            height: calc(100vh - 50px);
            background: #f5f5f5;
            border-left: 1px solid #ddd;
            padding: 20px;
            overflow-y: auto;
            display: none;
        }

        /* Adjust main content when details sidebar is visible */
        .has-group-details #main-content {
            margin-right: 300px;
        }

        #modelsTable {
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        #modelsTable th,
        #modelsTable td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        #modelsTable th {
            background-color: #f8fafc;
            font-weight: 600;
            color: #4a5568;
        }

        #modelsTable tr:hover {
            background-color: #f8fafc;
        }

        details summary {
            cursor: pointer;
            color: #3b82f6;
        }

        details summary:hover {
            color: #2563eb;
        }

        .access-section {
            margin: 10px 0;
            padding: 5px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .access-title {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 5px;
        }

        .access-list {
            list-style: none;
            padding-left: 15px;
            margin: 5px 0;
        }

        .access-list li {
            padding: 2px 0;
            color: #2d3748;
        }

        .no-access {
            color: #a0aec0;
            font-style: italic;
            padding-left: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
        }

        .success-message {
            color: #059669;
            background-color: #ecfdf5;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .error-message {
            color: #dc2626;
            background-color: #fef2f2;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        #addGroupResultJson {
            background: #f8fafc;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    {% include 'navigation.html' %}

    <!-- Secondary Navigation -->
    <div id="secondary-sidebar">
        <h2>OWI-USERS</h2>
        <div class="menu-item" onclick="showFeature('create-user')">Create User</div>
        <div class="menu-item" onclick="showFeature('get-all-users')">Get All Users</div>
        <div class="menu-item" onclick="showFeature('get-user-by-id')">Get User by ID</div>
        <div class="menu-item" onclick="showFeature('get-user-by-email')">Get User by Email</div>
        <div class="menu-item" onclick="showFeature('get-user-token')">Get User Token</div>
        <div class="menu-item" onclick="showFeature('get-user-login')">Get Login URL</div>

        <h2>OWI-GROUPS</h2>
        <div class="menu-item" onclick="showFeature('create-group')">Create Group</div>
        <div class="menu-item" onclick="showFeature('manage-group')">Manage Group</div>
        <div class="menu-item" onclick="showFeature('add-users-to-group')">Add Users to Group</div>

        <h2>OWI-MODELS</h2>
        <div class="menu-item" onclick="showFeature('get-user-models')">Get User Models</div>
        <div class="menu-item" onclick="showFeature('add-group-to-model')">Add Group to Model</div>

        <h2>OWI-CONFIG</h2>
        <div class="menu-item" onclick="showFeature('get-owi-config')">Get Configuration</div>
    </div>

    <div id="main-content" class="has-secondary-sidebar">
        <h1>OWI API Test Interface</h1>
        
        <div id="api-key-section">
            <label for="apiKey">API Key:</label>
            <input type="text" id="apiKey" required value="{{ api_key }}">
       
        </div>

        <div id="create-user" class="feature-section active">
            <h3>Create New User</h3>
            <div class="api-form">
                <p class="help-text">Create a new user account. All fields are required.</p>
                
                <label for="userName">Full Name:</label>
                <input type="text" id="userName" 
                       placeholder="Enter full name" 
                       value="" 
                       autocomplete="off"
                       required><br>
                
                <label for="newUserEmail">Email Address:</label>
                <input type="email" id="newUserEmail" 
                       placeholder="Enter email address" 
                       value="" 
                       autocomplete="off"
                       required><br>
                
                <label for="userPassword">Password:</label>
                <input type="password" id="userPassword" 
                       placeholder="Enter password" 
                       value="" 
                       autocomplete="new-password"
                       required><br>
                
                <label for="userRole">Role:</label>
                <input type="text" id="userRole" value="user" readonly><br>
                <p class="help-text">All new users are assigned the 'user' role by default</p>
                
                <button onclick="createUser()">Create User</button>
                <div id="createUserResult" class="result-display"></div>
            </div>
        </div>

        <div id="get-all-users" class="feature-section">
            <h3>Get All Users</h3>
            <button onclick="getAllUsers()">Get All Users</button>
            <pre id="getAllUsersResult"></pre>
        </div>

        <div id="get-user-by-id" class="feature-section">
            <h3>Get User by ID</h3>
            <select id="userId">
                <option value="">Select a user ID</option>
            </select>
            <button onclick="getUserById()">Get User</button>
            <pre id="getUserByIdResult"></pre>
        </div>

        <div id="get-user-by-email" class="feature-section">
            <h3>Get User by Email</h3>
            <input type="email" id="userEmail" placeholder="Enter user email">
            <button onclick="getUserByEmail()">Get User</button>
            <pre id="getUserByEmailResult"></pre>
        </div>

        <div id="create-group" class="feature-section">
            <h3>Create New Group</h3>
            <div class="api-form">
                <label for="groupName">Group Name:</label>
                <input type="text" id="groupName" placeholder="Enter group name" required><br>

                <label for="groupDescription">Description:</label>
                <textarea id="groupDescription" placeholder="Enter group description"></textarea><br>

                <label for="groupOwner">Owner ID:</label>
                <input type="text" id="groupOwner" readonly><br>
                <p class="help-text">This is your user ID as the group owner</p>

                <label>Default Permissions:</label>
                <textarea id="groupPermissions" readonly rows="8" style="width: 100%; font-family: monospace;">
{
  "workspace": {
    "models": true,
    "knowledge": false,
    "prompts": false,
    "tools": false
  },
  "chat": {
    "file_upload": true,
    "delete": true,
    "edit": true,
    "temporary": true
  }
}</textarea>

                <label>Members:</label>
                <select id="groupMembers" multiple></select>
                <p class="help-text">Hold Ctrl/Cmd to select multiple users. You'll be added as owner automatically.</p>

                <button onclick="createGroup()">Create Group</button>
                <div id="createGroupResult" class="result-display"></div>
            </div>
        </div>

        <div id="manage-group" class="feature-section">
            <h3>Manage Group</h3>
            <div class="api-form">
                <label for="selectGroup">Select Group:</label>
                <select id="selectGroup" onchange="loadGroupDetails()">
                    <option value="">Select a group</option>
                </select>
            </div>

            <div id="add-user-section" style="margin-top: 20px; border-top: 1px solid #ddd; padding-top: 20px;">
                <h4>Add User to Group</h4>
                
                <div class="api-form">
                    <label for="addUserEmail">Add by Email:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="email" 
                               id="addUserEmail" 
                               placeholder="Enter user email"
                               style="flex: 1;">
                        <button onclick="addUserByEmail()">Add User by Email</button>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <label for="addUserId">Add by User ID:</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="addUserId" style="flex: 1;">
                                <option value="">Select a user</option>
                            </select>
                            <button onclick="addUserById()">Add User by ID</button>
                        </div>
                    </div>

                    <div id="addUserResult" class="result-display" style="margin-top: 15px;"></div>
                </div>
            </div>
        </div>

        <div id="add-users-to-group" class="feature-section">
            <h3>Add Users to Group</h3>
            <div class="api-form">
                <label for="groupSelect">Select Group:</label>
                <select id="groupSelect" onchange="loadGroupUsers()">
                    <option value="">Select a group</option>
                </select>

                <div id="groupUsersSection" style="display: none; margin-top: 20px;">
                    <!-- Current members section -->
                    <div style="margin-bottom: 20px;">
                        <label>Current Members:</label>
                        <div id="currentMembers" class="members-list" style="
                            background: #f8fafc;
                            padding: 10px;
                            border-radius: 4px;
                            border: 1px solid #e2e8f0;
                            margin-top: 5px;
                        ">
                            <em>No members</em>
                        </div>
                    </div>

                    <!-- Add new member section -->
                    <label for="availableUsers">Add New Member:</label>
                    <select id="availableUsers">
                        <option value="">Select a user</option>
                    </select>
                    <button onclick="addUserToSelectedGroup()" style="margin-top: 10px;">Add User</button>
                    <div id="addUserToGroupResult" class="result-display"></div>
                </div>
            </div>
        </div>

        <div id="get-user-models" class="feature-section">
            <h3>Get User Models</h3>
            <div class="api-form">
                <button onclick="getUserModels()" class="primary-button">Get My Models</button>

                <div id="userModelsResult" style="margin-top: 20px;">
                    <table id="modelsTable" style="width: 100%; display: none;">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Base Model</th>
                                <th>Description</th>
                                <th>Access Control</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="add-group-to-model" class="feature-section">
            <h3>Add Group to Model</h3>
            <div class="api-form">
                <div class="form-group">
                    <label for="modelName">Model Name:</label>
                    <input type="text" id="modelName" placeholder="Enter model name">
                </div>

                <div class="form-group">
                    <label for="modelGroupSelect">Select Group:</label>
                    <select id="modelGroupSelect">
                        <option value="">Select a group</option>
                    </select>
                </div>

                <button onclick="addGroupToModel()" class="primary-button">Add Group to Model</button>
                
                <div id="addGroupResult" style="margin-top: 20px;">
                    <pre id="addGroupResultJson" style="display: none;"></pre>
                </div>
            </div>
        </div>

        <div id="get-owi-config" class="feature-section">
            <h3>OWI Configuration</h3>
            <div class="api-form">
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button onclick="getOwiConfig()" class="primary-button">Get Config</button>
                    <button onclick="setOwiConfig()" class="primary-button">Update Config with LAMB URL</button>
                </div>
                <div id="configResult" style="margin-top: 20px;">
                    <pre id="configResultJson" style="
                        background: #f8fafc;
                        padding: 15px;
                        border-radius: 4px;
                        border: 1px solid #e2e8f0;
                        overflow-x: auto;
                        display: none;
                    "></pre>
                </div>
            </div>
        </div>

        <div id="get-user-token" class="feature-section">
            <h3>Get User Auth Token</h3>
            <div class="api-form">
                <div class="form-group">
                    <label for="tokenUserEmail">User Email:</label>
                    <input type="email" id="tokenUserEmail" placeholder="Enter user email">
                </div>
                <button onclick="getUserToken()" class="primary-button">Get Auth Token</button>
                <div id="getUserTokenResult" class="result-display"></div>
            </div>
        </div>

        <div id="get-user-login" class="feature-section">
            <h3>Get User Login URL</h3>
            <div class="api-form">
                <div class="form-group">
                    <label for="loginUserEmail">Select User:</label>
                    <select id="loginUserEmail" class="form-control">
                        <option value="">Select a user</option>
                    </select>
                </div>
                <button onclick="getUserLoginUrl()" class="primary-button">Get Login URL</button>
                <div id="getUserLoginResult" class="result-display"></div>
            </div>
        </div>
    </div>

    <div id="group-details-sidebar">
        <h3>Group Details</h3>
        <div class="api-form">
            <label for="manageGroupName">Name:</label>
            <input type="text" id="manageGroupName" required><br>

            <label for="manageGroupDescription">Description:</label>
            <textarea id="manageGroupDescription"></textarea><br>

            <label>Owner:</label>
            <div id="groupOwnerDisplay"></div>

            <label>Permissions:</label>
            <textarea id="manageGroupPermissions" rows="8" style="width: 100%; font-family: monospace;"></textarea>

            <label>Current Members:</label>
            <select id="manageGroupMembers" multiple></select>
            <p class="help-text">Hold Ctrl/Cmd to select multiple users</p>

            <div style="margin-top: 20px; border-top: 1px solid #ddd; padding-top: 20px;">
                <label>Add New Member:</label>
                <select id="addGroupMember" style="margin-bottom: 10px;">
                    <option value="">Select a user to add</option>
                </select>
                <div style="display: flex; gap: 10px;">
                    <button onclick="addSelectedUserToGroup()" style="flex: 1;">Add Member</button>
                </div>
                <div id="addMemberResult" class="result-display" style="margin-top: 10px; font-size: 0.9em;"></div>
            </div>

            <div style="margin-top: 20px;">
                <button onclick="updateGroup()">Update Group</button>
                <button onclick="deleteGroup()" class="danger-button" style="margin-left: 10px;">Delete Group</button>
            </div>
            <div id="manageGroupResult" class="result-display"></div>
        </div>
    </div>

    <script>
        // Add navigation function
        function navigateTo(url) {
            window.location.href = url;
        }
        
        window.addEventListener('load', async () => {
            document.getElementById('userName').value = '';
            document.getElementById('newUserEmail').value = '';
            document.getElementById('userPassword').value = '';
            await getActiveUser();  // Get active user first
            await getAllUsers();  // Then get all users for the dropdowns
            await loadGroups();  // Add this line
        });

        async function makeRequest(url, method = 'GET') {
            try {
                console.log(`Making request to ${url} [${method}]`);
                const apiKey = document.getElementById('apiKey').value;
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                console.log(`Response from ${url}:`, data);
                return data;
            } catch (error) {
                console.error(`Request failed for ${url}:`, error);
                return { error: error.message };
            }
        }

        async function getAllUsers() {
            const result = await makeRequest('/lamb/v1/OWI/users');
            document.getElementById('getAllUsersResult').textContent = 
                JSON.stringify(result, null, 2);
            
            // Populate both user ID dropdowns
            const userIdSelect = document.getElementById('userId');
            const addUserSelect = document.getElementById('addUserId');
            
            // Clear existing options except the first one
            userIdSelect.innerHTML = '<option value="">Select a user ID</option>';
            addUserSelect.innerHTML = '<option value="">Select a user</option>';
            
            if (result && Array.isArray(result)) {
                result.forEach(user => {
                    // For the main user ID dropdown
                    const option1 = document.createElement('option');
                    option1.value = user.id;
                    option1.textContent = `${user.id} - ${user.name}`;
                    userIdSelect.appendChild(option1);

                    // For the add user dropdown
                    const option2 = document.createElement('option');
                    option2.value = user.id;
                    option2.textContent = `${user.name} (${user.email})`;
                    addUserSelect.appendChild(option2);
                });
            }

            return result;
        }

        async function getUserById() {
            const userId = document.getElementById('userId').value;
            if (!userId) {
                alert('Please select a user ID');
                return;
            }
            const result = await makeRequest(`/lamb/v1/OWI/users/${userId}`);
            document.getElementById('getUserByIdResult').textContent = 
                JSON.stringify(result, null, 2);
        }

        async function getUserByEmail() {
            const email = document.getElementById('userEmail').value;
            if (!email) {
                alert('Please enter an email');
                return;
            }
            const result = await makeRequest(`/lamb/v1/OWI/users/email/${email}`);
            document.getElementById('getUserByEmailResult').textContent = 
                JSON.stringify(result, null, 2);
        }

        async function createUser() {
            const name = document.getElementById('userName').value;
            const email = document.getElementById('newUserEmail').value;
            const password = document.getElementById('userPassword').value;
            const role = document.getElementById('userRole').value;

            if (!name || !email || !password) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                const apiKey = document.getElementById('apiKey').value;
                const response = await fetch('/lamb/v1/OWI/users', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        email: email,
                        password: password,
                        role: role
                    })
                });
                const result = await response.json();
                document.getElementById('createUserResult').textContent = 
                    JSON.stringify(result, null, 2);
                
                // Clear the form
                document.getElementById('userName').value = '';
                document.getElementById('newUserEmail').value = '';
                document.getElementById('userPassword').value = '';
                
                // Reload the users list to update the dropdown
                getAllUsers();
            } catch (error) {
                document.getElementById('createUserResult').textContent = 
                    JSON.stringify({ error: error.message }, null, 2);
            }
        }

        function showFeature(featureId) {
            // Hide all feature sections
            document.querySelectorAll('.feature-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Show the selected feature section
            const selectedSection = document.getElementById(featureId);
            if (selectedSection) {
                selectedSection.style.display = 'block';
            }
            
            // Handle specific feature initializations
            if (featureId === 'manage-group') {
                loadGroups();
            } else if (featureId === 'add-users-to-group') {
                loadGroups();
                loadAllUsers();
            } else if (featureId === 'add-group-to-model') {
                loadGroupsForModel();
            } else if (featureId === 'get-user-login' || featureId === 'get-user-token') {
                populateUserEmailDropdowns();
            }
        }

        // Call this when the page loads to show the first feature by default
        window.addEventListener('load', () => {
            showFeature('create-user');  // Or whichever feature you want to show by default
        });

        // Add class to body to indicate secondary sidebar presence
        document.body.classList.add('has-secondary-sidebar');

        let activeUser = null;

        async function getActiveUser() {
            try {
                const userDisplay = document.getElementById('userDisplayName');
                if (!userDisplay || !userDisplay.textContent) {
                    throw new Error('No user is logged in');
                }
                
                const email = userDisplay.textContent.trim();
                const apiKey = document.getElementById('apiKey').value;
                const response = await fetch(`/lamb/v1/OWI/users/email/${email}`, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const user = await response.json();
                if (user && user.id) {
                    activeUser = user;  // Store user object for its ID
                    document.getElementById('groupOwner').value = user.id;  // Display the owner ID
                    return user;
                }
                throw new Error('Failed to get active user');
            } catch (error) {
                console.error('Error getting active user:', error);
                return null;
            }
        }

        async function createGroup() {
            if (!activeUser) {
                alert('No active user found. Please refresh the page.');
                return;
            }

            const name = document.getElementById('groupName').value;
            const description = document.getElementById('groupDescription').value;
            const permissions = JSON.parse(document.getElementById('groupPermissions').value);
            const members = Array.from(document.getElementById('groupMembers').selectedOptions)
                .map(option => option.value);

            if (!name) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                const apiKey = document.getElementById('apiKey').value;
                const response = await fetch('/lamb/v1/OWI/groups', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name,
                        user_id: activeUser.id,
                        description,
                        permissions,
                        user_ids: members
                    })
                });
                const result = await response.json();
                document.getElementById('createGroupResult').textContent = 
                    JSON.stringify(result, null, 2);
                
                // Clear form
                document.getElementById('groupName').value = '';
                document.getElementById('groupDescription').value = '';
            } catch (error) {
                document.getElementById('createGroupResult').textContent = 
                    JSON.stringify({ error: error.message }, null, 2);
            }
        }

        async function loadGroups() {
            try {
                console.log('Attempting to load groups...');
                if (!activeUser || !activeUser.id) {
                    console.log('No active user found');
                    return [];
                }
                
                // Use get_user_groups endpoint instead of get_all_groups
                const groups = await makeRequest(`/lamb/v1/OWI/groups/user/${activeUser.id}`);
                console.log('Groups response:', groups);
                
                const selectGroup = document.getElementById('selectGroup');
                const groupSelect = document.getElementById('groupSelect');
                
                selectGroup.innerHTML = '<option value="">Select a group</option>';
                groupSelect.innerHTML = '<option value="">Select a group</option>';
                
                if (groups && groups.data && Array.isArray(groups.data)) {
                    console.log(`Found ${groups.data.length} groups`);
                    groups.data.forEach(group => {
                        // For manage group dropdown
                        const option1 = document.createElement('option');
                        option1.value = group.id;
                        option1.textContent = group.name;
                        selectGroup.appendChild(option1);

                        // For add users to group dropdown
                        const option2 = document.createElement('option');
                        option2.value = group.id;
                        option2.textContent = group.name;
                        groupSelect.appendChild(option2);
                    });
                } else {
                    console.log('Groups response is not in expected format:', groups);
                }
                return groups.data || [];
            } catch (error) {
                console.error('Error in loadGroups:', error);
                return [];
            }
        }

        async function loadGroupDetails() {
            const groupId = document.getElementById('selectGroup').value;
            const detailsSidebar = document.getElementById('group-details-sidebar');
            
            if (!groupId) {
                detailsSidebar.style.display = 'none';
                document.body.classList.remove('has-group-details');
                return;
            }

            try {
                const group = await makeRequest(`/lamb/v1/OWI/groups/${groupId}`);
                
                if (group && group.data && group.data.id) {
                    document.getElementById('manageGroupName').value = group.data.name;
                    document.getElementById('manageGroupDescription').value = group.data.description || '';
                    document.getElementById('groupOwnerDisplay').textContent = group.data.user_id;
                    document.getElementById('manageGroupPermissions').value = 
                        JSON.stringify(group.data.permissions, null, 2);
                    
                    // Update members dropdown
                    const membersSelect = document.getElementById('manageGroupMembers');
                    const addMemberSelect = document.getElementById('addGroupMember');
                    membersSelect.innerHTML = '';
                    addMemberSelect.innerHTML = '<option value="">Select a user to add</option>';
                    
                    const allUsers = await getAllUsers();
                    if (Array.isArray(allUsers)) {
                        allUsers.forEach(user => {
                            // For current members list
                            if (group.data.user_ids && group.data.user_ids.includes(user.id)) {
                                const option = document.createElement('option');
                                option.value = user.id;
                                option.textContent = `${user.name} (${user.email})`;
                                option.selected = true;
                                membersSelect.appendChild(option);
                            } else {
                                // For add member dropdown (only show non-members)
                                const option = document.createElement('option');
                                option.value = user.id;
                                option.textContent = `${user.name} (${user.email})`;
                                addMemberSelect.appendChild(option);
                            }
                        });
                    }
                    
                    // Show the sidebar
                    detailsSidebar.style.display = 'block';
                    document.body.classList.add('has-group-details');
                }
            } catch (error) {
                console.error('Error loading group details:', error);
            }
        }

        async function updateGroup() {
            const groupId = document.getElementById('selectGroup').value;
            if (!groupId) return;

            try {
                const apiKey = document.getElementById('apiKey').value;
                const response = await fetch(`/lamb/v1/OWI/groups/${groupId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: document.getElementById('manageGroupName').value,
                        description: document.getElementById('manageGroupDescription').value,
                        permissions: JSON.parse(document.getElementById('manageGroupPermissions').value),
                        user_ids: Array.from(document.getElementById('manageGroupMembers').selectedOptions)
                            .map(option => option.value)
                    })
                });
                const result = await response.json();
                document.getElementById('manageGroupResult').textContent = 
                    JSON.stringify(result, null, 2);
                
                // Refresh groups list
                await loadGroups();
            } catch (error) {
                document.getElementById('manageGroupResult').textContent = 
                    JSON.stringify({ error: error.message }, null, 2);
            }
        }

        async function deleteGroup() {
            const groupId = document.getElementById('selectGroup').value;
            if (!groupId || !confirm('Are you sure you want to delete this group?')) return;

            try {
                const apiKey = document.getElementById('apiKey').value;
                const response = await fetch(`/lamb/v1/OWI/groups/${groupId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                const result = await response.json();
                document.getElementById('manageGroupResult').textContent = 
                    JSON.stringify(result, null, 2);
                
                // Reset and refresh
                document.getElementById('groupDetails').style.display = 'none';
                document.getElementById('selectGroup').value = '';
                await loadGroups();
            } catch (error) {
                document.getElementById('manageGroupResult').textContent = 
                    JSON.stringify({ error: error.message }, null, 2);
            }
        }

        async function addUserByEmail() {
            const groupId = document.getElementById('selectGroup').value;
            const email = document.getElementById('addUserEmail').value;
            
            if (!groupId) {
                alert('Please select a group first');
                return;
            }
            if (!email) {
                alert('Please enter an email address');
                return;
            }

            try {
                const apiKey = document.getElementById('apiKey').value;
                const response = await fetch(`/lamb/v1/OWI/groups/${groupId}/users/email/${email}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                document.getElementById('addUserResult').textContent = 
                    JSON.stringify(result, null, 2);
                
                if (result.status === 'success') {
                    // Refresh group details
                    await loadGroupDetails();
                    document.getElementById('addUserEmail').value = '';
                }
            } catch (error) {
                document.getElementById('addUserResult').textContent = 
                    JSON.stringify({ error: error.message }, null, 2);
            }
        }

        async function addUserById() {
            const groupId = document.getElementById('selectGroup').value;
            const userId = document.getElementById('addUserId').value;
            
            if (!groupId) {
                alert('Please select a group first');
                return;
            }
            if (!userId) {
                alert('Please select a user');
                return;
            }

            try {
                const apiKey = document.getElementById('apiKey').value;
                const response = await fetch(`/lamb/v1/OWI/groups/${groupId}/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                document.getElementById('addUserResult').textContent = 
                    JSON.stringify(result, null, 2);
                
                if (result.status === 'success') {
                    // Refresh group details
                    await loadGroupDetails();
                    document.getElementById('addUserId').value = '';
                }
            } catch (error) {
                document.getElementById('addUserResult').textContent = 
                    JSON.stringify({ error: error.message }, null, 2);
            }
        }

        async function addSelectedUserToGroup() {
            const groupId = document.getElementById('selectGroup').value;
            const userId = document.getElementById('addGroupMember').value;
            const resultDiv = document.getElementById('addMemberResult');
            
            if (!groupId) {
                alert('Please select a group first');
                return;
            }
            if (!userId) {
                alert('Please select a user to add');
                return;
            }

            try {
                const apiKey = document.getElementById('apiKey').value;
                const response = await fetch(`/lamb/v1/OWI/groups/${groupId}/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                resultDiv.textContent = result.status === 'success' ? 
                    'Member added successfully' : 
                    `Error: ${result.error || 'Failed to add member'}`;
                
                if (result.status === 'success') {
                    // Refresh group details
                    await loadGroupDetails();
                }
            } catch (error) {
                resultDiv.textContent = `Error: ${error.message}`;
            }
        }

        async function loadGroupUsers() {
            const groupId = document.getElementById('groupSelect').value;
            const userSelect = document.getElementById('availableUsers');
            const section = document.getElementById('groupUsersSection');
            const membersDiv = document.getElementById('currentMembers');
            
            if (!groupId) {
                section.style.display = 'none';
                return;
            }

            try {
                // Get group details to know current members
                const group = await makeRequest(`/lamb/v1/OWI/groups/${groupId}`);
                const currentMembers = group.data.user_ids || [];

                // Get all users
                const allUsers = await getAllUsers();
                
                // Reset and populate user dropdown with non-members
                userSelect.innerHTML = '<option value="">Select a user</option>';
                
                // Reset current members display
                membersDiv.innerHTML = '';
                
                if (Array.isArray(allUsers)) {
                    const currentMembersList = [];
                    const availableUsers = [];
                    
                    allUsers.forEach(user => {
                        if (currentMembers.includes(user.id)) {
                            // Add to current members display
                            currentMembersList.push(
                                `<div class="member-item" style="padding: 5px 0;">
                                    ${user.name} (${user.email})
                                </div>`
                            );
                        } else {
                            // Add to available users dropdown
                            const option = document.createElement('option');
                            option.value = user.id;
                            option.textContent = `${user.name} (${user.email})`;
                            userSelect.appendChild(option);
                            availableUsers.push(user);
                        }
                    });
                    
                    // Update members display
                    if (currentMembersList.length > 0) {
                        membersDiv.innerHTML = currentMembersList.join('');
                    } else {
                        membersDiv.innerHTML = '<em>No members</em>';
                    }
                }
                
                section.style.display = 'block';
            } catch (error) {
                console.error('Error loading group users:', error);
            }
        }

        // Update addUserToSelectedGroup to refresh the display after adding a user
        async function addUserToSelectedGroup() {
            const groupId = document.getElementById('groupSelect').value;
            const userId = document.getElementById('availableUsers').value;
            const resultDiv = document.getElementById('addUserToGroupResult');
            
            if (!groupId || !userId) {
                alert('Please select both a group and a user');
                return;
            }

            try {
                const apiKey = document.getElementById('apiKey').value;
                const response = await fetch(`/lamb/v1/OWI/groups/${groupId}/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                resultDiv.textContent = result.status === 'success' ? 
                    'User added successfully to group' : 
                    `Error: ${result.error || 'Failed to add user'}`;
                
                if (result.status === 'success') {
                    // Refresh the display
                    await loadGroupUsers();
                }
            } catch (error) {
                resultDiv.textContent = `Error: ${error.message}`;
            }
        }

        async function getUserModels() {
            const userEmail = document.getElementById('userDisplayName').textContent;
            if (!userEmail) {
                alert('No authenticated user found. Please log in first.');
                return;
            }

            try {
                const apiKey = document.getElementById('apiKey').value;
                const response = await fetch(
                    `/lamb/v1/OWI/models?user_email=${encodeURIComponent(userEmail)}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        }
                    }
                );
                
                const result = await response.json();
                const table = document.getElementById('modelsTable');
                const tbody = table.querySelector('tbody');
                tbody.innerHTML = '';
                
                if (result.status === 'success' && result.data.length > 0) {
                    result.data.forEach(async model => {
                        const row = document.createElement('tr');
                        // Get group names for read access
                        const readGroupNames = await Promise.all(
                            model.access_control.read.group_ids.map(async groupId => {
                                try {
                                    const groupResponse = await fetch(
                                        `/lamb/v1/OWI/groups/${groupId}`,
                                        {
                                            headers: {
                                                'Authorization': `Bearer ${apiKey}`
                                            }
                                        }
                                    );
                                    const groupData = await groupResponse.json();
                                    return groupData.status === 'success' ? groupData.data.name : groupId;
                                } catch (error) {
                                    console.error(`Error fetching group ${groupId}:`, error);
                                    return groupId;
                                }
                            })
                        );

                        // Get group names for write access
                        const writeGroupNames = await Promise.all(
                            model.access_control.write.group_ids.map(async groupId => {
                                try {
                                    const groupResponse = await fetch(
                                        `/lamb/v1/OWI/groups/${groupId}`,
                                        {
                                            headers: {
                                                'Authorization': `Bearer ${apiKey}`
                                            }
                                        }
                                    );
                                    const groupData = await groupResponse.json();
                                    return groupData.status === 'success' ? groupData.data.name : groupId;
                                } catch (error) {
                                    console.error(`Error fetching group ${groupId}:`, error);
                                    return groupId;
                                }
                            })
                        );

                        row.innerHTML = `
                            <td>${model.name}</td>
                            <td>${model.base_model_id || 'N/A'}</td>
                            <td>${model.meta.description || 'No description'}</td>
                            <td>
                                <details>
                                    <summary>View Access</summary>
                                    <div style="padding: 10px; background: #f5f5f5; border-radius: 4px; margin-top: 5px;">
                                        <strong>Read Access:</strong>
                                        <div class="access-section">
                                            <div class="access-title">Groups:</div>
                                            ${readGroupNames.length > 0 ? 
                                                `<ul class="access-list">
                                                    ${readGroupNames.map(name => `<li>${name}</li>`).join('')}
                                                </ul>` : 
                                                '<div class="no-access">No groups</div>'
                                            }
                                        </div>
                                        <div class="access-section">
                                            <div class="access-title">Users:</div>
                                            ${model.access_control.read.user_ids.length > 0 ? 
                                                `<ul class="access-list">
                                                    ${model.access_control.read.user_ids.map(id => `<li>${id}</li>`).join('')}
                                                </ul>` : 
                                                '<div class="no-access">No users</div>'
                                            }
                                        </div>
                                        <strong>Write Access:</strong>
                                        <div class="access-section">
                                            <div class="access-title">Groups:</div>
                                            ${writeGroupNames.length > 0 ? 
                                                `<ul class="access-list">
                                                    ${writeGroupNames.map(name => `<li>${name}</li>`).join('')}
                                                </ul>` : 
                                                '<div class="no-access">No groups</div>'
                                            }
                                        </div>
                                        <div class="access-section">
                                            <div class="access-title">Users:</div>
                                            ${model.access_control.write.user_ids.length > 0 ? 
                                                `<ul class="access-list">
                                                    ${model.access_control.write.user_ids.map(id => `<li>${id}</li>`).join('')}
                                                </ul>` : 
                                                '<div class="no-access">No users</div>'
                                            }
                                        </div>
                                    </div>
                                </details>
                            </td>
                            <td>${model.is_active ? 
                                '<span style="color: green;">Active</span>' : 
                                '<span style="color: red;">Inactive</span>'
                            }</td>
                        `;
                        tbody.appendChild(row);
                    });
                    table.style.display = 'table';
                } else {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center;">
                                No models found for this user
                            </td>
                        </tr>
                    `;
                    table.style.display = 'table';
                }
            } catch (error) {
                console.error('Error fetching user models:', error);
                document.getElementById('userModelsResult').innerHTML = 
                    `<p style="color: red;">Error fetching models: ${error.message}</p>`;
            }
        }

        async function loadGroupsForModel() {
            console.log('Loading groups for model...');
            try {
                const apiKey = document.getElementById('apiKey').value;
                const response = await fetch('/lamb/v1/OWI/groups/user/' + activeUser.id, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });
                
                const result = await response.json();
                console.log('Groups response:', result);
                const groupSelect = document.getElementById('modelGroupSelect');
                if (!groupSelect) {
                    console.error('Could not find modelGroupSelect element');
                    return;
                }
                groupSelect.innerHTML = '<option value="">Select a group</option>';
                
                if (result.status === 'success' && result.data && Array.isArray(result.data)) {
                    result.data.forEach((group) => {
                        const option = document.createElement('option');
                        option.value = group.name;
                        option.textContent = group.name;
                        groupSelect.appendChild(option);
                    });
                    console.log('Added', result.data.length, 'groups to select');
                } else {
                    console.log('No groups found or error in response');
                }
            } catch (error) {
                console.error('Error loading groups:', error);
                const groupSelect = document.getElementById('modelGroupSelect');
                if (groupSelect) {
                    groupSelect.innerHTML = '<option value="">Error loading groups</option>';
                }
            }
        }

        async function addGroupToModel() {
            const modelName = document.getElementById('modelName').value;
            const groupName = document.getElementById('modelGroupSelect').value;
            const userEmail = document.getElementById('userDisplayName').textContent;
            const resultDiv = document.getElementById('addGroupResult');
            const resultJson = document.getElementById('addGroupResultJson');

            if (!modelName || !groupName) {
                alert('Please fill in all fields');
                return;
            }

            if (!userEmail) {
                alert('No authenticated user found. Please log in first.');
                return;
            }

            try {
                const apiKey = document.getElementById('apiKey').value;
                console.log('Sending request with:', {
                    userEmail,
                    modelName,
                    groupName
                });
                const response = await fetch(
                    `/lamb/v1/OWI/models/add_group?user_owner_email=${encodeURIComponent(userEmail)}&model_name=${encodeURIComponent(modelName)}&group_name=${encodeURIComponent(groupName)}`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        }
                    }
                );

                const result = await response.json();
                console.log('Response:', result);
                
                if (result.status === 'success') {
                    resultDiv.innerHTML = '<div class="success-message">Group added successfully!</div>';
                    resultJson.textContent = JSON.stringify(result.data, null, 2);
                    resultJson.style.display = 'block';
                } else {
                    resultDiv.innerHTML = `<div class="error-message">Error: ${result.error || result.detail || 'Unknown error'}</div>`;
                    resultJson.style.display = 'none';
                }
            } catch (error) {
                console.error('Error adding group to model:', error);
                resultDiv.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
                resultJson.style.display = 'none';
            }
        }

        async function getOwiConfig() {
            try {
                const apiKey = document.getElementById('apiKey').value;
                const response = await fetch('/lamb/v1/OWI/get_owi_config', {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                const resultJson = document.getElementById('configResultJson');
                
                if (result.status === 'success') {
                    resultJson.textContent = JSON.stringify(result.data, null, 2);
                    resultJson.style.display = 'block';
                } else {
                    resultJson.textContent = JSON.stringify({
                        error: result.error || result.detail || 'Failed to fetch configuration'
                    }, null, 2);
                    resultJson.style.display = 'block';
                }
            } catch (error) {
                console.error('Error fetching OWI config:', error);
                const resultJson = document.getElementById('configResultJson');
                resultJson.textContent = JSON.stringify({
                    error: error.message
                }, null, 2);
                resultJson.style.display = 'block';
            }
        }

        async function setOwiConfig() {
            try {
                const apiKey = document.getElementById('apiKey').value;
                const response = await fetch('/lamb/v1/OWI/set_owi_config', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                const configResult = document.getElementById('configResult');
                const resultJson = document.getElementById('configResultJson');
                
                if (result.status === 'success') {
                    // Add prominent warning before the config display
                    configResult.innerHTML = `
                        <div style="
                            margin-bottom: 20px;
                            padding: 15px;
                            background-color: #fff3cd;
                            border: 2px solid #ffc107;
                            border-radius: 4px;
                            color: #856404;
                            font-size: 1.1em;
                            text-align: center;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        ">
                            <div style="font-size: 1.5em; margin-bottom: 8px;">⚠️ Important ⚠️</div>
                            <strong>Please restart Open WebUI for the changes to take effect</strong>
                        </div>
                        <div style="
                            margin-bottom: 15px;
                            padding: 10px;
                            background-color: #ecfdf5;
                            border: 1px solid #059669;
                            border-radius: 4px;
                            color: #059669;
                        ">
                            ✅ Configuration updated successfully!
                        </div>
                        <pre id="configResultJson" style="
                            background: #f8fafc;
                            padding: 15px;
                            border-radius: 4px;
                            border: 1px solid #e2e8f0;
                            overflow-x: auto;
                        ">${JSON.stringify(result.data, null, 2)}</pre>
                    `;
                    // After successful update, get the new config
                    await getOwiConfig();
                } else {
                    resultJson.textContent = JSON.stringify({
                        error: result.error || result.detail || 'Failed to update configuration'
                    }, null, 2);
                    resultJson.style.display = 'block';
                }
            } catch (error) {
                console.error('Error updating OWI config:', error);
                const resultJson = document.getElementById('configResultJson');
                resultJson.textContent = JSON.stringify({
                    error: error.message
                }, null, 2);
                resultJson.style.display = 'block';
            }
        }

        async function getUserToken() {
            const email = document.getElementById('tokenUserEmail').value;
            const resultDiv = document.getElementById('getUserTokenResult');

            if (!email) {
                alert('Please enter a user email');
                return;
            }

            try {
                const apiKey = document.getElementById('apiKey').value;
                const response = await fetch(`/lamb/v1/OWI/users/token/${encodeURIComponent(email)}`, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    resultDiv.innerHTML = `
                        <div class="success-message">Token retrieved successfully!</div>
                        <pre style="
                            background: #f8fafc;
                            padding: 15px;
                            border-radius: 4px;
                            border: 1px solid #e2e8f0;
                            margin-top: 10px;
                            overflow-x: auto;
                        ">${result.data.token}</pre>`;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error-message">
                            Error: ${result.error || 'Failed to retrieve token'}
                        </div>`;
                }
            } catch (error) {
                console.error('Error getting user token:', error);
                resultDiv.innerHTML = `
                    <div class="error-message">
                        Error: ${error.message}
                    </div>`;
            }
        }

        async function getUserLoginUrl() {
            const select = document.getElementById('loginUserEmail');
            const email = select.value;
            const resultDiv = document.getElementById('getUserLoginResult');

            if (!email) {
                alert('Please select a user');
                return;
            }

            try {
                const apiKey = document.getElementById('apiKey').value;
                const response = await fetch(`/lamb/v1/OWI/users/login/${encodeURIComponent(email)}`, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.text();
                if (response.ok) {
                    // Remove any quotes from the result
                    const cleanUrl = result.replace(/['"]+/g, '');
                    resultDiv.innerHTML = `
                        <div class="success-message">Login URL retrieved successfully!</div>
                        <div style="margin-top: 10px;">
                            <pre style="
                                background: #f8fafc;
                                padding: 15px;
                                border-radius: 4px;
                                border: 1px solid #e2e8f0;
                                overflow-x: auto;
                                word-break: break-all;
                                white-space: pre-wrap;
                            "><a href="${cleanUrl}" target="_blank" style="text-decoration: underline; color: #3b82f6;">${cleanUrl}</a></pre>
                            <button onclick="copyLoginUrl('${result}')" class="secondary-button" style="margin-top: 10px;">
                                Copy URL
                            </button>
                            <button onclick="window.open('${cleanUrl}', '_blank')" class="secondary-button" style="margin-top: 10px; margin-left: 10px;">
                                Open in New Tab
                            </button>
                        </div>`;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error-message">
                            Error: ${result || 'Failed to retrieve login URL'}
                        </div>`;
                }
            } catch (error) {
                console.error('Error getting login URL:', error);
                resultDiv.innerHTML = `
                    <div class="error-message">
                        Error: ${error.message}
                    </div>`;
            }
        }

        function copyLoginUrl(url) {
            navigator.clipboard.writeText(url).then(() => {
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy URL:', err);
                alert('Failed to copy URL to clipboard');
            });
        }

        async function populateUserEmailDropdowns() {
            try {
                const users = await getAllUsers();
                if (Array.isArray(users)) {
                    // Get the login email dropdown
                    const loginEmailSelect = document.getElementById('loginUserEmail');
                    loginEmailSelect.innerHTML = '<option value="">Select a user</option>';
                    
                    // Get the token email dropdown
                    const tokenEmailSelect = document.getElementById('tokenUserEmail');
                    tokenEmailSelect.innerHTML = '<option value="">Select a user</option>';
                    
                    users.forEach(user => {
                        // Add to login dropdown
                        const option1 = document.createElement('option');
                        option1.value = user.email;
                        option1.textContent = `${user.name} (${user.email})`;
                        loginEmailSelect.appendChild(option1);
                        
                        // Add to token dropdown
                        const option2 = document.createElement('option');
                        option2.value = user.email;
                        option2.textContent = `${user.name} (${user.email})`;
                        tokenEmailSelect.appendChild(option2);
                    });
                }
            } catch (error) {
                console.error('Error populating email dropdowns:', error);
            }
        }
    </script>
</body>
</html>
