<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LTI Users Management</title>
    <link rel="stylesheet" href="/static/css/lamb.css">
</head>
<body>
    <!-- Include shared navigation -->
    {% include 'navigation.html' %}

    <!-- Secondary Navigation -->
    <div id="secondary-sidebar">
        <h2>Features</h2>
        <div class="menu-item active" onclick="showFeature('create-user')">Create User</div>
        <div class="menu-item" onclick="showFeature('get-user')">Get User</div>
        <div class="menu-item" onclick="showFeature('get-users-by-assistant')">Users by Assistant</div>
        <div class="menu-item" onclick="showFeature('sign-in-user')">Sign In User</div>
    </div>

    <div id="main-content" class="has-secondary-sidebar">
        <h1>LTI Users Management</h1>

        <!-- Add API key section -->
        <div id="api-key-section">
            <label for="apiKey">API Key:</label>
            <input type="text" id="apiKey" required value="{{ api_key }}">
        </div>

        <div id="create-user" class="feature-section active">
            <h2>Create LTI User</h2>
            <div class="api-form">
                <label for="assistant_select">Select Assistant:</label>
                <select id="assistant_select" onchange="handleAssistantSelect()" required>
                    <option value="">Select an assistant</option>
                </select><br>

                <label for="assistant_id">Assistant ID:</label>
                <input type="text" id="assistant_id" name="assistant_id" readonly required><br>

                <label for="assistant_name">Assistant Name:</label>
                <input type="text" id="assistant_name" name="assistant_name" readonly required><br>

                <label for="group_id">Group ID:</label>
                <input type="text" id="group_id" name="group_id" readonly required><br>

                <label for="group_name">Group Name:</label>
                <input type="text" id="group_name" name="group_name" readonly required><br>

                <label for="assistant_owner">Assistant Owner:</label>
                <input type="text" id="assistant_owner" name="assistant_owner" readonly required><br>

                <label for="lti_context_id">LTI Context ID (OAuth Consumer Name):</label>
                <input type="text" id="lti_context_id" name="lti_context_id" readonly required><br>

                <label for="user_email">User Email:</label>
                <input type="email" id="user_email" name="user_email" required><br>

                <label for="user_name">User Name:</label>
                <input type="text" id="user_name" name="user_name" required><br>

                <label for="user_display_name">User Display Name:</label>
                <input type="text" id="user_display_name" name="user_display_name" required><br>

                <label for="lti_app_id">LTI App ID:</label>
                <input type="text" id="lti_app_id" name="lti_app_id"><br>

                <button onclick="createLTIUser()">Create LTI User</button>
                <pre id="createResult"></pre>
            </div>
        </div>

        <div id="get-user" class="feature-section">
            <h2>Get LTI User</h2>
            <div class="api-form">
                <label for="getUserEmail">User Email:</label>
                <input type="email" id="getUserEmail" required><br>
                <button onclick="getLTIUser()">Get LTI User</button>
                <pre id="getResult"></pre>
            </div>
        </div>

        <div id="get-users-by-assistant" class="feature-section">
            <h2>Get Users by Assistant ID</h2>
            <div class="api-form">
                <label for="getAssistantId">Assistant ID:</label>
                <input type="text" id="getAssistantId" required><br>
                <button onclick="getLTIUsersByAssistant()">Get Users</button>
                <pre id="getAssistantResult"></pre>
            </div>
        </div>

        <div id="sign-in-user" class="feature-section">
            <h2>Sign In LTI User</h2>
            <div class="api-form">
                <label for="signInEmail">User Email:</label>
                <input type="email" id="signInEmail" required><br>

                <label for="signInUsername">Username:</label>
                <input type="text" id="signInUsername" required><br>

                <label for="signInOauthConsumer">OAuth Consumer Name:</label>
                <input type="text" id="signInOauthConsumer" required><br>

                <button onclick="signInLTIUser()">Sign In User</button>
                <pre id="signInResult"></pre>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');
            const currentPath = window.location.pathname;
            const menuItems = document.querySelectorAll('#top-bar .menu-item');
            
            menuItems.forEach(item => {
                const itemPath = item.getAttribute('data-path');
                if (currentPath === itemPath || 
                    (currentPath.startsWith(itemPath) && itemPath !== '/') ||
                    (currentPath.startsWith('/lamb/v1/OWI') && itemPath === '/lamb/v1/owi_test')) {
                    item.classList.add('active');
                }
                
                item.addEventListener('click', () => {
                    window.location.href = itemPath;
                });
            });

            // Check for authenticated user and update display
            const authenticatedUser = localStorage.getItem('authenticatedUser');
            if (authenticatedUser) {
                document.getElementById('user-section').style.display = 'flex';
                document.getElementById('userDisplayName').textContent = authenticatedUser;
            }

            console.log('Loading published assistants...');
            // Load published assistants when page loads
            loadPublishedAssistants();
        });

        function logout() {
            localStorage.removeItem('authenticatedUser');
            window.location.href = '/lamb/v1';
        }

        function showFeature(featureId) {
            // Hide all feature sections
            document.querySelectorAll('.feature-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Remove active class from all menu items
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected feature section
            document.getElementById(featureId).style.display = 'block';
            
            // Add active class to selected menu item
            Array.from(document.querySelectorAll('.menu-item')).find(
                item => item.textContent.toLowerCase().includes(featureId)
            )?.classList.add('active');
        }

        async function createLTIUser() {
            const data = {
                assistant_id: document.getElementById('assistant_id').value,
                assistant_name: document.getElementById('assistant_name').value,
                group_id: document.getElementById('group_id').value,
                group_name: document.getElementById('group_name').value,
                assistant_owner: document.getElementById('assistant_owner').value,
                user_email: document.getElementById('user_email').value,
                user_name: document.getElementById('user_name').value,
                user_display_name: document.getElementById('user_display_name').value,
                lti_context_id: document.getElementById('lti_context_id').value,
                lti_app_id: document.getElementById('lti_app_id').value
            };

            try {
                const response = await fetch('/lamb/v1/lti_users/lti_user/', { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer {{ api_key }}'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                document.getElementById('createResult').textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                document.getElementById('createResult').textContent = 'Error: ' + error.message;
            }
        }

        async function getLTIUser() {
            const userEmail = document.getElementById('getUserEmail').value;

            try {
                const response = await fetch(`/lamb/v1/lti_users/lti_user/${userEmail}`, { 
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer {{ api_key }}'
                    }
                });

                const result = await response.json();
                document.getElementById('getResult').textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                document.getElementById('getResult').textContent = 'Error: ' + error.message;
            }
        }

        async function getLTIUsersByAssistant() {
            const assistantId = document.getElementById('getAssistantId').value;

            try {
                const response = await fetch(`/lamb/v1/lti_users/lti_users/assistant/${assistantId}`, { 
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer {{ api_key }}'
                    }
                });

                const result = await response.json();
                document.getElementById('getAssistantResult').textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                document.getElementById('getAssistantResult').textContent = 'Error: ' + error.message;
            }
        }

        async function loadPublishedAssistants() {
            const apiKey = document.getElementById('apiKey').value;
            try {
                const response = await fetch('/lamb/v1/assistant/get_published_assistants/', {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Published assistants response:', await response.clone().text());
                const assistants = await response.json();
                console.log('Parsed assistants:', assistants);

                const select = document.getElementById('assistant_select');
                select.innerHTML = '<option value="">Select an assistant</option>';

                assistants.forEach(assistant => {
                    const option = document.createElement('option');
                    option.value = JSON.stringify({
                        assistant_id: assistant.assistant_id.toString(),
                        assistant_name: assistant.assistant_name,
                        group_id: assistant.group_id,
                        group_name: assistant.group_name,
                        assistant_owner: assistant.assistant_owner,
                        oauth_consumer_name: assistant.oauth_consumer_name
                    });
                    option.textContent = `${assistant.assistant_name} (${assistant.group_name})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading published assistants:', error);
                document.getElementById('createResult').textContent = 
                    `Error loading assistants: ${error.message}`;
            }
        }

        function handleAssistantSelect() {
            const select = document.getElementById('assistant_select');
            if (select.value) {
                const assistantData = JSON.parse(select.value);
                
                // Populate the readonly fields
                document.getElementById('assistant_id').value = assistantData.assistant_id;
                document.getElementById('assistant_name').value = assistantData.assistant_name;
                document.getElementById('group_id').value = assistantData.group_id;
                document.getElementById('group_name').value = assistantData.group_name;
                document.getElementById('assistant_owner').value = assistantData.assistant_owner;
                document.getElementById('lti_context_id').value = assistantData.oauth_consumer_name;
            } else {
                // Clear the fields if no assistant is selected
                ['assistant_id', 'assistant_name', 'group_id', 'group_name', 'assistant_owner', 'lti_context_id'].forEach(id => {
                    document.getElementById(id).value = '';
                });
            }
        }

        async function signInLTIUser() {
            const data = {
                email: document.getElementById('signInEmail').value,
                username: document.getElementById('signInUsername').value,
                oauth_consumer_name: document.getElementById('signInOauthConsumer').value
            };

            try {
                const response = await fetch('/lamb/v1/lti_users/sign_in_lti_user', { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer {{ api_key }}'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (response.ok) {
                    document.getElementById('signInResult').innerHTML = 
                        `<div style="color: green;">Success! Token: ${result.token}</div>`;
                } else {
                    document.getElementById('signInResult').innerHTML = 
                        `<div style="color: red;">Error: ${result.detail || 'Unknown error'}</div>`;
                }
            } catch (error) {
                document.getElementById('signInResult').innerHTML = 
                    `<div style="color: red;">Error: ${error.message}</div>`;
            }
        }

        // Add class to body to indicate secondary sidebar presence
        document.body.classList.add('has-secondary-sidebar');
    </script>
</body>
</html>
