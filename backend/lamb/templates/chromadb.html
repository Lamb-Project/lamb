<!DOCTYPE html>
<html>
  <head>
    <title>ChromaDB Management</title>
    <link rel="stylesheet" href="/static/css/lamb.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <style>
      .json-view {
        font-family: monospace;
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      .collection-card:hover {
        transform: translateY(-2px);
        transition: all 0.2s ease;
      }
      .metadata {
        background-color: #f8f8f8;
        padding: 10px;
        margin: 5px 0;
        border-radius: 3px;
        font-family: monospace;
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      details {
        margin: 10px 0;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: white;
      }
      summary {
        padding: 10px;
        cursor: pointer;
        background-color: #f0f0f0;
        border-radius: 5px;
        font-weight: bold;
      }
      summary:hover {
        background-color: #e8e8e8;
      }
      .details-content {
        padding: 15px;
      }
      #chromaContent {
        transition: all 0.3s ease;
      }
    </style>
  </head>
  <body>
    {% include 'navigation.html' %}

    <!-- Include the secondary sidebar partial -->
    {% with active_page='view-kb' %} {% include 'chromadb_sidebar.html' %} {%
    endwith %}

    <div id="main-content" class="has-secondary-sidebar">
      <div id="view-kb" class="feature-section">
        <div class="container mx-auto px-4 py-8">
          <h1 class="text-3xl font-bold mb-8">Database Explorer</h1>

          <!-- Knowledge Bases Section -->
          <div class="mb-12">
            <h2 class="text-2xl font-semibold mb-4">
              Knowledge Bases (SQLite)
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {% if knowledge_bases %} {% for kb in knowledge_bases %}
              <div class="bg-white rounded-lg shadow-md p-6 collection-card">
                <h3 class="text-lg font-semibold mb-2">{{ kb.name }}</h3>
                <p class="text-gray-600 mb-2">
                  {{ kb.description or 'No description' }}
                </p>
                <div class="text-sm text-gray-500">
                  <p>ID: {{ kb.id[:8] }}...</p>
                  <p>User ID: {{ kb.user_id }}</p>
                  <p>Files: {{ kb.file_count }}</p>
                </div>
                <button
                  onclick="showKBDetails('{{ kb.id }}', '{{ kb.name }}')"
                  class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm"
                >
                  View Details
                </button>
              </div>
              {% endfor %} {% else %}
              <div class="col-span-3 text-center py-8 text-gray-500">
                No knowledge bases found. Create one in Open WebUI first.
              </div>
              {% endif %}
            </div>
          </div>

          <!-- ChromaDB Details Section -->
          <div id="chromaSection" class="mb-12 hidden">
            <h2 class="text-2xl font-semibold mb-4">
              ChromaDB Contents:
              <span id="selectedKBName" class="text-blue-600"></span>
            </h2>
            <div id="chromaContent" class="bg-white rounded-lg shadow-md p-6">
              <!-- ChromaDB collections will be inserted here -->
            </div>
          </div>
        </div>
      </div>

      <div id="view-raw" class="feature-section">
        <h2>View Raw</h2>
        <div class="api-form">
          <!-- Placeholder for View Raw content -->
          <p>View Raw content will be implemented here.</p>
        </div>
      </div>
    </div>

    {% include 'chromadb_modal.html' %}

    <script>
      function showFeature(featureId) {
        // Hide all feature sections
        document.querySelectorAll(".feature-section").forEach((section) => {
          section.style.display = "none";
        });

        if (featureId === "view-raw") {
          window.location.href = "/lamb/v1/chromadb/raw";
          return;
        }

        // Show the selected feature section
        const selectedSection = document.getElementById(featureId);
        if (selectedSection) {
          selectedSection.style.display = "block";
        }
      }

      // Show view-kb by default only if we're not already showing something else
      window.addEventListener("load", () => {
        const path = window.location.pathname;
        if (path === "/lamb/v1/chromadb/" || path === "/lamb/v1/chromadb") {
          showFeature("view-kb");
        }
      });

      // Add class to body to indicate secondary sidebar presence
      document.body.classList.add("has-secondary-sidebar");

      function showKBDetails(kbId, kbName) {
        // Update selected KB name
        document.getElementById("selectedKBName").textContent = kbName;

        // Show the ChromaDB section
        document.getElementById("chromaSection").classList.remove("hidden");

        // Scroll to ChromaDB section smoothly
        document.getElementById("chromaSection").scrollIntoView({
          behavior: "smooth",
          block: "start",
        });

        // Fetch and display data
        fetch(`/lamb/v1/chromadb/api/kb/${kbId}`)
          .then((response) => response.json())
          .then((data) => {
            const chromaContent = document.getElementById("chromaContent");
            chromaContent.innerHTML = ""; // Clear previous content

            if (!data.kb_info) {
              chromaContent.innerHTML = `
                            <div class="text-gray-500 text-center py-8">
                                Knowledge base not found or error occurred
                            </div>
                        `;
              return;
            }

            if (data.collections.length === 0) {
              chromaContent.innerHTML = `
                            <div class="text-gray-500 text-center py-8">
                                No ChromaDB collections found for this knowledge base
                            </div>
                        `;
              return;
            }

            // Create content for each collection
            data.collections.forEach((collection) => {
              const collectionDiv = document.createElement("div");
              collectionDiv.className = "mb-6";

              // Collection header with file information
              const uniqueFiles = new Set();
              const fileChunks = {};

              // Process documents to group by source file
              collection.documents.forEach((doc) => {
                const filename =
                  doc.metadata?.source ||
                  doc.metadata?.file_name ||
                  "Unknown file";
                uniqueFiles.add(filename);
                if (!fileChunks[filename]) {
                  fileChunks[filename] = [];
                }
                fileChunks[filename].push(doc);
              });

              const numFiles = uniqueFiles.size;

              collectionDiv.innerHTML = `
                            <details class="mb-4">
                                <summary class="cursor-pointer p-3 bg-gray-50 hover:bg-gray-100 rounded flex justify-between items-center">
                                    <span>${collection.name}</span>
                                    <span class="text-sm text-gray-600">
                                        ${
                                          collection.documents.length
                                        } chunks from ${numFiles} files
                                    </span>
                                </summary>
                                <div class="p-4">
                                    <div class="mb-4 text-sm text-gray-600 bg-gray-50 p-3 rounded">
                                        <p class="font-semibold mb-2">Source Files:</p>
                                        ${Array.from(uniqueFiles)
                                          .map(
                                            (filename) => `
                                            <div class="ml-2">â€¢ ${filename} (${fileChunks[filename].length} chunks)</div>
                                        `
                                          )
                                          .join("")}
                                    </div>
                                    
                                    ${Array.from(uniqueFiles)
                                      .map(
                                        (filename) => `
                                        <details class="mb-4 border rounded">
                                            <summary class="cursor-pointer p-3 bg-gray-50 hover:bg-gray-100">
                                                ${filename} (${
                                          fileChunks[filename].length
                                        } chunks)
                                            </summary>
                                            <div class="p-4">
                                                ${fileChunks[filename]
                                                  .map(
                                                    (doc) => `
                                                    <div class="border-b py-3">
                                                        <div><strong>Chunk ID:</strong> ${
                                                          doc.id
                                                        }</div>
                                                        <div class="mt-2"><strong>Content:</strong> ${
                                                          doc.document
                                                        }</div>
                                                        <details class="mt-2">
                                                            <summary class="cursor-pointer text-sm text-blue-600">
                                                                View Metadata
                                                            </summary>
                                                            <pre class="metadata mt-2 text-sm">
${JSON.stringify(doc.metadata, null, 2)}
                                                            </pre>
                                                        </details>
                                                    </div>
                                                `
                                                  )
                                                  .join("")}
                                            </div>
                                        </details>
                                    `
                                      )
                                      .join("")}
                                </div>
                            </details>
                        `;

              chromaContent.appendChild(collectionDiv);
            });
          });
      }

      // Show/Hide Modal Functions
      function showNewCollectionModal() {
        document
          .getElementById("newCollectionModal")
          .classList.remove("hidden");
      }

      function hideNewCollectionModal() {
        document.getElementById("newCollectionModal").classList.add("hidden");
        document.getElementById("newCollectionForm").reset();
      }

      // Form Submission
      document
        .getElementById("newCollectionForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const collectionName =
            document.getElementById("collectionName").value;
          const description = document.getElementById("description").value;

          try {
            const response = await fetch("/lamb/v1/chromadb/api/collections", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                collection_name: collectionName,
                description: description,
              }),
            });

            const result = await response.json();

            if (result.success) {
              // Refresh the page to show the new collection
              window.location.reload();
            } else {
              alert("Error creating collection: " + result.message);
            }
          } catch (error) {
            alert("Error creating collection: " + error.message);
          }

          hideNewCollectionModal();
        });

      // Collection Details Function
      async function showCollectionDetails(collectionName) {
        try {
          const response = await fetch(
            `/chromadb/api/collection/${collectionName}`
          );
          const data = await response.json();

          const contentDiv = document.getElementById("chromaContent");
          contentDiv.innerHTML = `
                    <h2 class="text-xl font-bold mb-4">${collectionName}</h2>
                    <div class="mb-4">
                        <p class="text-gray-600">Documents: ${data.count}</p>
                    </div>
                    <div class="mt-4">
                        <h3 class="text-lg font-semibold mb-2">Documents</h3>
                        <div class="space-y-2">
                            ${data.documents
                              .map(
                                (doc, index) => `
                                <details class="border rounded-lg">
                                    <summary class="p-3 bg-gray-50">Document ${
                                      index + 1
                                    }</summary>
                                    <div class="p-3">
                                        <pre class="whitespace-pre-wrap">${JSON.stringify(
                                          doc,
                                          null,
                                          2
                                        )}</pre>
                                    </div>
                                </details>
                            `
                              )
                              .join("")}
                        </div>
                    </div>
                `;
        } catch (error) {
          console.error("Error fetching collection details:", error);
          alert("Error fetching collection details");
        }
      }
    </script>
  </body>
</html>
