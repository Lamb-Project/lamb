<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lamb Database Permissions Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="/static/css/lamb.css">
</head>
<body>
    {% include 'navigation.html' %}

    <!-- Secondary Navigation -->
    <div id="secondary-sidebar">
        <h2>Features</h2>
        <div class="menu-item active" onclick="showFeature('manage-permissions')">Manage Permissions</div>
        <div class="menu-item" onclick="showFeature('test-filters')">Test Filters</div>
        <div class="menu-item" onclick="showFeature('database-setup')">Database Setup</div>
    </div>

    <div id="main-content" class="has-secondary-sidebar">
        <h1>Permissions Management</h1>

        <!-- Database Setup Section -->
        <div id="database-setup" class="feature-section">
            <h2>Database Setup</h2>
            <div class="api-form">
                <label for="apiKey">API Key:</label>
                <input type="text" id="apiKey" value="{{ api_key }}" required>
                <button id="createDatabaseBtn" class="primary-button">Create Database and Tables</button>
                <div id="dbMessage" class="message"></div>
            </div>
        </div>

        <!-- Permissions Management Section -->
        <div id="manage-permissions" class="feature-section active">
            <h2>Manage User Permissions</h2>
            <div class="api-form">
                <form id="permissionsForm">
                    <label for="userEmail">User Email:</label>
                    <input type="email" id="userEmail" required>
                    
                    <button type="button" id="getPermissionsBtn" class="secondary-button">Get Current Permissions</button>
                    
                    <label for="includeModels">Include Models (comma-separated):</label>
                    <input type="text" id="includeModels" placeholder="model1, model2, ...">
                    
                    <label for="excludeModels">Exclude Models (comma-separated):</label>
                    <input type="text" id="excludeModels" placeholder="model3, model4, ...">
                    
                    <button type="submit" class="primary-button">Update Permissions</button>
                </form>
                <div id="message" class="message"></div>

                <div id="permissionsDisplay">
                    <h3>Current Permissions:</h3>
                    <ul id="permissionsList" class="permissions-list"></ul>
                </div>
            </div>
        </div>

        <!-- Test Filters Section -->
        <div id="test-filters" class="feature-section">
            <h2>Test Model Filters</h2>
            <div class="api-form">
                <form id="filterModelsForm">
                    <label for="filterUserEmail">User Email:</label>
                    <input type="email" id="filterUserEmail" required>
                    
                    <label for="modelNames">Model Names (comma-separated):</label>
                    <input type="text" id="modelNames" required placeholder="model1, model2, ...">
                    
                    <button type="submit" class="primary-button">Filter Models</button>
                </form>
                <div id="filterResult" class="results-display"></div>
            </div>
        </div>
    </div>

    <script>
        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            const authenticatedUser = localStorage.getItem('authenticatedUser');
            if (!authenticatedUser) {
                window.location.href = '/lamb/v1';  // Redirect to main page if not authenticated
                return;
            }
        });

        function showFeature(featureId) {
            // Hide all feature sections
            document.querySelectorAll('.feature-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Remove active class from all menu items
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected feature section
            document.getElementById(featureId).style.display = 'block';
            
            // Add active class to selected menu item
            Array.from(document.querySelectorAll('.menu-item')).find(
                item => item.textContent.toLowerCase().includes(featureId)
            )?.classList.add('active');
        }

        function getApiKey() {
            return document.getElementById('apiKey').value;
        }

        document.getElementById('permissionsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const userEmail = document.getElementById('userEmail').value;
            const includeModels = document.getElementById('includeModels').value.split(',').map(m => m.trim()).filter(m => m);
            const excludeModels = document.getElementById('excludeModels').value.split(',').map(m => m.trim()).filter(m => m);
            const apiKey = getApiKey();

            try {
                const response = await axios.post('/lamb/v1/auth/update_permissions', {
                    user_email: userEmail,
                    filter: {
                        include: includeModels,
                        exclude: excludeModels
                    }
                }, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });
                document.getElementById('message').textContent = 'Permissions updated successfully';
            } catch (error) {
                document.getElementById('message').textContent = 'Error updating permissions: ' + error.response.data.detail;
            }
        });

        // Function to get and display current permissions
        async function getPermissions() {
            const userEmail = document.getElementById('userEmail').value;
            const apiKey = getApiKey();
            if (!userEmail) {
                document.getElementById('message').textContent = 'Please enter a user email';
                return;
            }

            try {
                const response = await axios.get(`/lamb/v1/auth/get_permissions/${userEmail}`, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });
                const permissions = response.data;
                
                const includeModels = permissions.filter(p => p.access_type === 'include').map(p => p.model_name);
                const excludeModels = permissions.filter(p => p.access_type === 'exclude').map(p => p.model_name);
                
                document.getElementById('includeModels').value = includeModels.join(', ');
                document.getElementById('excludeModels').value = excludeModels.join(', ');
                
                displayPermissions(permissions); // Pass permissions data directly
                
                document.getElementById('message').textContent = 'Current permissions loaded';
            } catch (error) {
                document.getElementById('message').textContent = 'Error fetching permissions: ' + error.response.data.detail;
            }
        }

        // Add event listener to the Get Permissions button
        document.getElementById('getPermissionsBtn').addEventListener('click', getPermissions);

        // Function to create database and tables
        async function createDatabaseAndTables() {
            const apiKey = getApiKey();
            try {
                const response = await axios.post('/lamb/v1/auth/create_database_and_tables', {}, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });
                document.getElementById('message').textContent = response.data.message;
            } catch (error) {
                document.getElementById('message').textContent = 'Error creating database and tables: ' + error.response.data.error;
            }
        }

        // Add event listener to the Create Database and Tables button
        document.getElementById('createDatabaseBtn').addEventListener('click', createDatabaseAndTables);

        async function displayPermissions(permissions) {
            try {
                const permissionsList = document.getElementById('permissionsList');
                permissionsList.innerHTML = ''; // Clear existing list
                
                permissions.forEach(permission => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `${permission.model_name}: ${permission.access_type}`;
                    permissionsList.appendChild(listItem);
                });
                
                document.getElementById('message').textContent = 'Permissions loaded successfully';
            } catch (error) {
                document.getElementById('message').textContent = 'Error displaying permissions: ' + error.message;
            }
        }

        // Add event listener for the Filter Models form
        document.getElementById('filterModelsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('filterUserEmail').value;
            const models = document.getElementById('modelNames').value.split(',').map(m => m.trim()).filter(m => m);
            const apiKey = getApiKey();

            try {
                const response = await axios.post('/lamb/v1/auth/filter_models', {
                    email,
                    models
                }, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });
                const filteredModels = response.data;
                document.getElementById('filterResult').innerHTML = `
                    <h3>Filtered Models:</h3>
                    <ul>
                        ${filteredModels.map(model => `<li>${model}</li>`).join('')}
                    </ul>
                `;
            } catch (error) {
                document.getElementById('filterResult').textContent = 'Error filtering models: ' + (error.response?.data?.detail || error.message);
            }
        });
    </script>
</body>
</html>
