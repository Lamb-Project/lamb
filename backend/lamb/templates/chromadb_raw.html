<!DOCTYPE html>
<html>
  <head>
    <title>ChromaDB Raw View</title>
    <link rel="stylesheet" href="/static/css/lamb.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <style>
      .metadata {
        background-color: #f8f8f8;
        padding: 10px;
        margin: 5px 0;
        border-radius: 3px;
        font-family: monospace;
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      details {
        margin: 10px 0;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: white;
      }
      summary {
        padding: 10px;
        cursor: pointer;
        background-color: #f0f0f0;
        border-radius: 5px;
        font-weight: bold;
      }
      summary:hover {
        background-color: #e8e8e8;
      }
      .details-content {
        padding: 15px;
      }
      pre {
        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      .delete-btn {
        background-color: #ff4444;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 3px;
        cursor: pointer;
        margin-left: 10px;
      }
      .delete-btn:hover {
        background-color: #cc0000;
      }
      .feature-section {
        display: block !important;
      }
    </style>
  </head>
  <body>
    {% include 'navigation.html' %}

    <!-- Include the secondary sidebar partial -->
    {% with active_page='view-raw' %} {% include 'chromadb_sidebar.html' %} {%
    endwith %}

    <div id="main-content" class="has-secondary-sidebar">
      <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-8">ChromaDB Raw Explorer</h1>

        <div class="mb-8 flex justify-between items-center">
          <div class="text-gray-600">
            {% if collections %} Total Collections: {{ collections|length }} {%
            endif %}
          </div>
          {% if collections %}
          <button
            class="bg-red-600 text-white px-6 py-2 rounded hover:bg-red-700 transition-colors"
            onclick="deleteAllCollections()"
          >
            Delete All Collections
          </button>
          {% endif %}
        </div>

        <div id="collections">
          {% if collections %} {% for collection in collections %}
          <div
            class="bg-white rounded-lg shadow-md p-6 mb-6"
            id="collection-{{ collection.name }}"
          >
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-2xl font-semibold">
                <span class="text-blue-600">{{ collection.name }}</span>
                <span class="text-gray-500 text-lg"
                  >({{ collection.count }} documents)</span
                >
              </h2>
              <button
                class="delete-btn"
                onclick="deleteCollection('{{ collection.name }}')"
              >
                Delete Collection
              </button>
            </div>

            <details>
              <summary>Documents</summary>
              <div class="details-content">
                {% for doc in collection.documents %}
                <div class="border-b border-gray-200 py-4 last:border-b-0">
                  <div class="font-semibold text-gray-700">
                    ID: {{ doc.id }}
                  </div>
                  <div class="my-2">{{ doc.document }}</div>
                  <details>
                    <summary class="text-sm text-blue-600 cursor-pointer">
                      Document Metadata
                    </summary>
                    <div class="metadata mt-2">
                      <pre>{{ doc.metadata | tojson(indent=2) }}</pre>
                    </div>
                  </details>
                </div>
                {% endfor %}
              </div>
            </details>
          </div>
          {% endfor %} {% else %}
          <div class="text-center py-8 text-gray-500">
            No ChromaDB collections found
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    {% include 'chromadb_modal.html' %}

    <script>
      function deleteCollection(collectionName) {
        if (confirm("Are you sure you want to delete this collection?")) {
          fetch(`/lamb/v1/chromadb/api/delete_collection/${collectionName}`, {
            method: "POST",
            headers: {
              Accept: "application/json",
            },
          })
            .then(async (response) => {
              const contentType = response.headers.get("content-type");
              const isJson =
                contentType && contentType.includes("application/json");
              const data = isJson ? await response.json() : null;

              if (!response.ok) {
                if (data) {
                  throw new Error(data.error || "Failed to delete collection");
                } else {
                  throw new Error(
                    "Server error occurred while deleting collection"
                  );
                }
              }

              return data;
            })
            .then((data) => {
              if (data && data.success) {
                document
                  .getElementById("collection-" + collectionName)
                  .remove();
                if (
                  document.querySelectorAll("#collections > div").length === 0
                ) {
                  location.reload();
                }
              } else {
                alert(
                  "Error deleting collection: " +
                    (data?.error || "Unknown error")
                );
              }
            })
            .catch((error) => {
              console.error("Delete error:", error);
              alert("Error deleting collection: " + error.message);
            });
        }
      }

      function deleteAllCollections() {
        if (
          confirm(
            "Are you sure you want to delete ALL collections? This action cannot be undone!"
          )
        ) {
          if (
            confirm(
              "This will permanently delete all ChromaDB collections. Are you REALLY sure?"
            )
          ) {
            fetch("/lamb/v1/chromadb/api/delete_all_collections", {
              method: "POST",
              headers: {
                Accept: "application/json",
              },
            })
              .then(async (response) => {
                const contentType = response.headers.get("content-type");
                const isJson =
                  contentType && contentType.includes("application/json");
                const data = isJson ? await response.json() : null;

                if (!response.ok) {
                  if (data) {
                    let errorMessage =
                      data.error || "Failed to delete collections";
                    if (
                      data.failed_collections &&
                      data.failed_collections.length > 0
                    ) {
                      errorMessage += "\n\nFailed collections:";
                      data.failed_collections.forEach((fc) => {
                        errorMessage += `\n- ${fc.name}: ${fc.error}`;
                      });
                    }
                    throw new Error(errorMessage);
                  } else {
                    throw new Error(
                      "Server error occurred while deleting collections"
                    );
                  }
                }

                return data;
              })
              .then((data) => {
                if (data && data.success) {
                  alert(data.message);
                  location.reload();
                } else {
                  alert(
                    "Error deleting collections: " +
                      (data?.error || "Unknown error")
                  );
                }
              })
              .catch((error) => {
                console.error("Delete error:", error);
                alert("Error deleting collections:\n\n" + error.message);
              });
          }
        }
      }

      function showFeature(featureId) {
        if (featureId === "view-kb") {
          window.location.href = "/lamb/v1/chromadb/";
        }
      }

      // Add class to body to indicate secondary sidebar presence
      document.body.classList.add("has-secondary-sidebar");
    </script>
  </body>
</html>
