<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to Lamb</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="/static/css/lamb.css">
</head>
<body>
    {% include 'navigation.html' %}

    <!-- Secondary Navigation (Features) -->
    <div id="secondary-sidebar">
        <h2>Features</h2>
        <div class="menu-item active" onclick="showFeature('database-section')">Database</div>
        <div class="menu-item" onclick="showFeature('api-section')">API Settings</div>
    </div>

    <div id="main-content" class="has-secondary-sidebar">
        <h1>Welcome to Lamb</h1>
        
        <div id="authentication-section" class="feature-section active">
            <h2>Authentication</h2>
            <div class="auth-form">
                <label for="userEmail">Admin Email:</label>
                <input type="email" id="userEmail" placeholder="Enter admin email" required><br>
                <label for="userPassword">Password:</label>
                <input type="password" id="userPassword" placeholder="Enter password" required><br>
                <button onclick="verifyAdmin()">Login</button>
                <div id="authMessage"></div>
            </div>
        </div>

        <div id="token-section" class="feature-section" style="display: none;">
            <h2>Authentication Token</h2>
            <div class="token-display">
                <p>Your authentication token:</p>
                <textarea id="authToken" readonly rows="3"></textarea>
                <button onclick="copyToken()">Copy Token</button>
            </div>
        </div>

        <div id="database-section" class="feature-section" style="display: none;">
            <h2>Database Management</h2>
            <div id="api-key-section">
                <label for="apiKey">API Key:</label>
                <input type="text" id="apiKey" required value="{{ api_key }}"><br><br>
            </div>
            <button id="createDatabaseBtn">Create Database and Tables</button>
            <div id="message"></div>
        </div>

        <div id="api-section" class="feature-section" style="display: none;">
            <h2>API Configuration</h2>
            <!-- Add API configuration content here -->
        </div>

        <div id="creator-users-section" class="feature-section" style="display: none;">
            <h2>Creator Users Management</h2>
            
            <!-- Create Creator User Form -->
            <div class="form-section">
                <h3>Create Creator User</h3>
                <form id="createCreatorUserForm">
                    <label for="createUserEmail">Email:</label>
                    <input type="email" id="createUserEmail" required><br>
                    
                    <label for="createUserName">Name:</label>
                    <input type="text" id="createUserName" required><br>
                    
                    <button type="submit">Create User</button>
                </form>
                <pre id="createCreatorUserResponse"></pre>
            </div>

            <!-- Check Creator User Form -->
            <div class="form-section">
                <h3>Check Creator User</h3>
                <form id="checkCreatorUserForm">
                    <label for="checkUserEmail">Email:</label>
                    <input type="email" id="checkUserEmail" required><br>
                    
                    <button type="submit">Check User</button>
                </form>
                <pre id="checkCreatorUserResponse"></pre>
            </div>

            <!-- List Creator Users -->
            <div class="form-section">
                <h3>List All Creator Users</h3>
                <button onclick="listCreatorUsers()">List Users</button>
                <div id="creatorUsersTable" style="margin-top: 20px;">
                    <table class="users-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Config</th>
                            </tr>
                        </thead>
                        <tbody id="creatorUsersBody">
                        </tbody>
                    </table>
                </div>
                <pre id="listCreatorUsersResponse"></pre>
            </div>
        </div>
    </div>

    <script>
        function showFeature(featureId) {
            // Only show features if authenticated
            const authenticatedUser = localStorage.getItem('authenticatedUser');
            if (!authenticatedUser && featureId !== 'authentication-section') {
                return;
            }

            // Hide all feature sections
            document.querySelectorAll('.feature-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Remove active class from all menu items
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected feature section
            document.getElementById(featureId).style.display = 'block';
            
            // Add active class to selected menu item
            Array.from(document.querySelectorAll('.menu-item')).find(
                item => item.textContent.toLowerCase().includes(featureId)
            )?.classList.add('active');
        }

        // Add class to body to indicate secondary sidebar presence
        document.body.classList.add('has-secondary-sidebar');

        // Your existing JavaScript code...
        function getApiKey() {
            return document.getElementById('apiKey').value;
        }

        async function createDatabaseAndTables() {
            const apiKey = getApiKey();
            try {
                const response = await axios.post('/lamb/v1/auth/create_database_and_tables', {}, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });
                document.getElementById('message').textContent = response.data.message;
            } catch (error) {
                document.getElementById('message').textContent = 'Error creating database and tables: ' + error.response.data.error;
            }
        }

        document.getElementById('createDatabaseBtn').addEventListener('click', createDatabaseAndTables);

        async function verifyAdmin() {
            const email = document.getElementById('userEmail').value;
            const password = document.getElementById('userPassword').value;
            const apiKey = document.getElementById('apiKey').value;

            // Create the request payload
            const requestPayload = {
                email: email,
                password: password
            };
            
            // Log the request details
            console.log('Login Request URL:', '/lamb/v1/OWI/users/verify');
            console.log('Login Request Method:', 'POST');
            console.log('Login Request Headers:', {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            });
            console.log('Login Request Payload:', requestPayload);

            try {
                const response = await fetch('/lamb/v1/OWI/users/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(requestPayload)
                });

                const data = await response.json();
                
                if (response.ok && data.status === 'success' && data.data.role === 'admin') {
                    // Store the authenticated user email
                    localStorage.setItem('authenticatedUser', email);
                    
                    // Show success message
                    document.getElementById('authMessage').textContent = 'Authentication successful!';
                    document.getElementById('authMessage').style.color = 'green';
                    
                    // Show the features
                    document.getElementById('authentication-section').style.display = 'none';
                    document.getElementById('database-section').style.display = 'block';
                    document.getElementById('api-section').style.display = 'block';
                    
                    // Update secondary sidebar to show all features
                    document.querySelectorAll('#secondary-sidebar .menu-item').forEach(item => {
                        item.style.display = 'block';
                    });

                    // Show user section and update username
                    document.getElementById('user-section').style.display = 'flex';
                    document.getElementById('userDisplayName').textContent = email;

                    // Get the auth token
                    await getAuthToken();
                } else {
                    document.getElementById('authMessage').textContent = 'Authentication failed. Admin access required.';
                    document.getElementById('authMessage').style.color = 'red';
                }
            } catch (error) {
                document.getElementById('authMessage').textContent = 'Authentication error: ' + error.message;
                document.getElementById('authMessage').style.color = 'red';
            }
        }

        async function getAuthToken() {
            const email = localStorage.getItem('authenticatedUser');
            const apiKey = document.getElementById('apiKey').value;
            
            try {
                const response = await fetch(`/lamb/v1/OWI/users/token/${email}`, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.status === 'success') {
                    document.getElementById('authToken').value = data.data.token;
                    document.getElementById('token-section').style.display = 'block';
                } else {
                    document.getElementById('authMessage').textContent = 'Failed to retrieve token';
                    document.getElementById('authMessage').style.color = 'red';
                }
            } catch (error) {
                document.getElementById('authMessage').textContent = 'Error retrieving token: ' + error.message;
                document.getElementById('authMessage').style.color = 'red';
            }
        }

        function copyToken() {
            const tokenElement = document.getElementById('authToken');
            tokenElement.select();
            document.execCommand('copy');
            
            // Show feedback
            const button = document.querySelector('#token-section button');
            const originalText = button.textContent;
            button.textContent = 'Copied!';
            setTimeout(() => {
                button.textContent = originalText;
            }, 2000);
        }

        // Check authentication status on page load
        document.addEventListener('DOMContentLoaded', function() {
            const authenticatedUser = localStorage.getItem('authenticatedUser');
            if (authenticatedUser) {
                document.getElementById('authentication-section').style.display = 'none';
                document.getElementById('database-section').style.display = 'block';
                document.getElementById('api-section').style.display = 'block';
                document.getElementById('userEmail').value = authenticatedUser;
            } else {
                // Hide features if not authenticated
                document.getElementById('database-section').style.display = 'none';
                document.getElementById('api-section').style.display = 'none';
            }

            // Add event listeners for Enter key on login inputs
            const emailInput = document.getElementById('userEmail');
            const passwordInput = document.getElementById('userPassword');
            
            function handleEnterKey(event) {
                if (event.key === 'Enter') {
                    verifyAdmin();
                }
            }
            
            emailInput.addEventListener('keypress', handleEnterKey);
            passwordInput.addEventListener('keypress', handleEnterKey);

            // If user is authenticated, get the token
            if (authenticatedUser) {
                getAuthToken();
            }
        });

        document.getElementById('createCreatorUserForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const apiKey = document.getElementById('apiKey').value;
            
            const userData = {
                email: document.getElementById('createUserEmail').value,
                name: document.getElementById('createUserName').value
            };

            try {
                const response = await axios.post('/lamb/v1/creator_user/create', userData, {
                    headers: { 'Authorization': `Bearer ${apiKey}` }
                });
                
                document.getElementById('createCreatorUserResponse').innerHTML = 
                    `<p style="color: green;">User created successfully with ID: ${response.data}</p>`;
                
                // Clear form
                this.reset();
                
                // Refresh the users list if it's visible
                if (document.querySelector('.users-table').style.display !== 'none') {
                    await listCreatorUsers();
                }
            } catch (error) {
                document.getElementById('createCreatorUserResponse').innerHTML = 
                    `<p style="color: red;">Error creating user: ${error.response?.data?.detail || error.message}</p>`;
            }
        });

        document.getElementById('checkCreatorUserForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const apiKey = document.getElementById('apiKey').value;
            const email = document.getElementById('checkUserEmail').value;

            try {
                const response = await axios.get(`/lamb/v1/creator_user/check/${encodeURIComponent(email)}`, {
                    headers: { 'Authorization': `Bearer ${apiKey}` }
                });
                
                const userId = response.data;
                document.getElementById('checkCreatorUserResponse').innerHTML = userId ? 
                    `<p style="color: green;">User exists with ID: ${userId}</p>` :
                    `<p style="color: orange;">User not found</p>`;
                
            } catch (error) {
                document.getElementById('checkCreatorUserResponse').innerHTML = 
                    `<p style="color: red;">Error checking user: ${error.response?.data?.detail || error.message}</p>`;
            }
        });

        async function listCreatorUsers() {
            const apiKey = document.getElementById('apiKey').value;
            const table = document.querySelector('.users-table');
            const tbody = document.getElementById('creatorUsersBody');
            const responseElement = document.getElementById('listCreatorUsersResponse');

            try {
                const response = await axios.get('/lamb/v1/creator_user/list', {
                    headers: { 'Authorization': `Bearer ${apiKey}` }
                });
                
                tbody.innerHTML = '';
                
                if (response.data && response.data.length > 0) {
                    response.data.forEach(user => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${user.id}</td>
                            <td>${user.name}</td>
                            <td>${user.email}</td>
                            <td><pre style="margin: 0;">${JSON.stringify(user.user_config, null, 2)}</pre></td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    table.style.display = 'table';
                    responseElement.innerHTML = '';
                } else {
                    table.style.display = 'none';
                    responseElement.innerHTML = '<p>No creator users found</p>';
                }
            } catch (error) {
                table.style.display = 'none';
                responseElement.innerHTML = 
                    `<p style="color: red;">Error listing users: ${error.response?.data?.detail || error.message}</p>`;
            }
        }
    </script>

    <style>
        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .form-section h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #333;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .users-table th,
        .users-table td {
            padding: 12px;
            text-align: left;
            border: 1px solid #ddd;
        }

        .users-table th {
            background-color: #f5f5f5;
            font-weight: bold;
        }

        .users-table tr:hover {
            background-color: #f9f9f9;
        }

        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</body>
</html>
